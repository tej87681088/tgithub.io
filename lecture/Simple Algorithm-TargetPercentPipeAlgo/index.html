
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://tejtw.github.io/TQuantLab/lecture/Simple%20Algorithm-TargetPercentPipeAlgo/">
      
      
        <link rel="prev" href="../Install%20TQuant%20Lab%20%283%29/">
      
      
        <link rel="next" href="../TSMC%20buy%20and%20hold%20strategy/">
      
      
      <link rel="icon" href="../../images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.42">
    
    
      
        <title>Target Percent Pipeline Algorithm - TQuant Lab</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#target-percent-pipeline-algorithm" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="TQuant Lab" class="md-header__button md-logo" aria-label="TQuant Lab" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            TQuant Lab
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Target Percent Pipeline Algorithm
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-hidden="true"  type="radio" name="__palette" id="__palette_1">
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_3" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-hidden="true"  type="radio" name="__palette" id="__palette_3">
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="lime"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_4">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  TQuant-Lab

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../Data%20collection%20%283%29/" class="md-tabs__link">
          
  
    
  
  Lecture

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="TQuant Lab" class="md-nav__button md-logo" aria-label="TQuant Lab" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    TQuant Lab
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TQuant-Lab
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Lecture
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Lecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Data%20collection%20%283%29/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Data Collection
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Install%20TQuant%20Lab%20%283%29/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TQuant Lab 安裝教學
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Target Percent Pipeline Algorithm
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../TSMC%20buy%20and%20hold%20strategy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TSMC 買進持有策略
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Universe%20Analysis%EF%BC%8Dusing%20get_universe/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Universe Analysis－using get universe
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../get_universe%E8%AA%AA%E6%98%8E/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    get_universe說明
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="target-percent-pipeline-algorithm">Target Percent Pipeline Algorithm</h1>
<p>利用pipeline提供的買賣清單與持股權重進行定期再平衡的演算法。</p>
<p><span id="menu"></span>
本文件包含以下部份：</p>
<p><strong>基本設定</strong>
1. <a href="#Env">Set Environment Variables</a>
2. <a href="#Universe">Investment Universe</a>
3. <a href="#Ingest">Ingest</a>
4. <a href="#Imports">Imports</a>
5. <a href="#Pipeline">Pipeline</a></p>
<p><strong>參數說明與範例</strong></p>
<ol>
<li><a href="#APIReference">API Reference</a>：參數說明。</li>
<li><a href="#APIReference">class zipline.algo.pipeline_algo.TargetPercentPipeAlgo</a></li>
<li>
<p><a href="#date_rules">class zipline.api.date_rules</a></p>
</li>
<li>
<p><a href="#Examples">Examples</a>：範例。</p>
</li>
<li><a href="#Case1">Case 1－調整start_session與end_session</a></li>
<li><a href="#Case2">Case 2－調整max_leverage</a></li>
<li><a href="#Case3">Case 3－調整tradeday</a></li>
<li><a href="#Case4">Case 4－調整rebalance_date_rule</a></li>
<li><a href="#Case5">Case 5－調整slippage_model</a></li>
<li><a href="#Case6">Case 6－調整stocklist</a></li>
<li><a href="#Case7">Case 7－調整order_filling_policy</a></li>
<li><a href="#Case8">Case 8－調整allow_short</a></li>
<li><a href="#Case9">Case 9－調整cancel_datedelta</a>   </li>
<li><a href="#Case10">Case 10－調整limit_buy_multiplier</a>  </li>
<li><a href="#Case11">Case 11－調整custom_weight、analyze、record_vars、get_record_vars與get_transaction_detail</a>   </li>
</ol>
<p><span id="Env"></span></p>
<h1 id="1-set-environment-variables">1. Set Environment Variables</h1>
<p><a href="#menu">Return to Menu</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kn">import</span> <span class="nn">datetime</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kn">import</span> <span class="nn">tejapi</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="c1"># set tej_key and base</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TEJAPI_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;your key&quot;</span> 
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TEJAPI_BASE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;https://api.tej.com.tw&quot;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="c1"># set benchmark</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="n">benchmark</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;IR0001&#39;</span><span class="p">]</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="c1"># set calendar</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="n">calendar_name</span><span class="o">=</span><span class="s1">&#39;TEJ_XTAI&#39;</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="c1"># set bundle name</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="n">bundle_name</span> <span class="o">=</span> <span class="s1">&#39;tquant&#39;</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="c1"># set date</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2023-06-01&#39;</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="n">end</span><span class="o">=</span><span class="s1">&#39;2023-10-03&#39;</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="c1"># 由文字型態轉為Timestamp，供回測使用</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="n">tz</span> <span class="o">=</span> <span class="s1">&#39;UTC&#39;</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="n">start_dt</span><span class="p">,</span> <span class="n">end_dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">tz</span> <span class="o">=</span> <span class="n">tz</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">tz</span> <span class="o">=</span> <span class="n">tz</span><span class="p">)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="c1"># 設定os.environ[&#39;mdate&#39;] = start+&#39; &#39;+end，供ingest bundle使用</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;mdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">end</span>
</code></pre></div>
<p><span id="Universe"></span></p>
<h1 id="2-investment-universe">2. Investment Universe</h1>
<p>台灣50指數成分股</p>
<p><a href="#menu">Return to Menu</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">from</span> <span class="nn">zipline.sources.TEJ_Api_Data</span> <span class="kn">import</span> <span class="n">get_universe</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="n">StockList</span> <span class="o">=</span> <span class="n">get_universe</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">idx_id</span><span class="o">=</span><span class="s1">&#39;IX0002&#39;</span><span class="p">)</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">StockList</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Currently used TEJ API key call quota 67/9223372036854775807 (0.0%)
Currently used TEJ API key data quota 2255014/9223372036854775807 (0.0%)
55
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">StockList</span> <span class="o">+</span> <span class="n">benchmark</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&#39;1101 1216 1301 1303 1326 1402 1590 1605 2002 2207 2301 2303 2308 2317 2327 2330 2345 2357 2379 2382 2395 2408 2412 2454 2603 2609 2615 2801 2880 2881 2882 2883 2884 2885 2886 2887 2890 2891 2892 2912 3008 3034 3037 3045 3231 3711 4904 4938 5871 5876 5880 6415 6505 6669 9910 IR0001&#39;
</code></pre></div>
<p><span id="Ingest"></span></p>
<h1 id="3-ingest">3. Ingest</h1>
<p><a href="#menu">Return to Menu</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># Ingest pricing bundle</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="err">!</span><span class="n">zipline</span> <span class="n">ingest</span> <span class="o">-</span><span class="n">b</span> <span class="n">tquant</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Merging daily equity files:
Currently used TEJ API key call quota 72/9223372036854775807 (0.0%)
Currently used TEJ API key data quota 2261479/9223372036854775807 (0.0%)


[2024-03-13 02:40:44.060855] INFO: zipline.data.bundles.core: Ingesting tquant.
[2024-03-13 02:40:49.764291] INFO: zipline.data.bundles.core: Ingest tquant successfully.
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kn">from</span> <span class="nn">zipline.data.data_portal</span> <span class="kn">import</span> <span class="n">get_bundle_price</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="n">df_bundle_price</span> <span class="o">=</span> <span class="n">get_bundle_price</span><span class="p">(</span><span class="n">bundle_name</span><span class="o">=</span><span class="n">bundle_name</span><span class="p">,</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>                                   <span class="n">calendar_name</span><span class="o">=</span><span class="n">calendar_name</span><span class="p">,</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>                                   <span class="n">start_dt</span><span class="o">=</span><span class="n">start_dt</span><span class="p">,</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>                                   <span class="n">end_dt</span><span class="o">=</span><span class="n">end_dt</span><span class="p">)</span>
</code></pre></div>
<p><span id="Imports"></span></p>
<h1 id="4-imports-settings">4. Imports &amp; Settings</h1>
<p><a href="#menu">Return to Menu</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kn">import</span> <span class="nn">warnings</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="kn">import</span> <span class="nn">empyrical</span> <span class="k">as</span> <span class="nn">ep</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="kn">from</span> <span class="nn">logbook</span> <span class="kn">import</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">StderrHandler</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="n">WARNING</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">MaxNLocator</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="kn">from</span> <span class="nn">TejToolAPI.TejToolAPI</span> <span class="kn">import</span> <span class="o">*</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="kn">from</span> <span class="nn">zipline.api</span> <span class="kn">import</span> <span class="n">record</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="kn">from</span> <span class="nn">zipline.utils.calendar_utils</span> <span class="kn">import</span> <span class="n">get_calendar</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="kn">from</span> <span class="nn">zipline.utils.run_algo</span> <span class="kn">import</span>  <span class="p">(</span><span class="n">get_transaction_detail</span><span class="p">,</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>                                     <span class="n">get_record_vars</span><span class="p">)</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="kn">from</span> <span class="nn">zipline.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span><span class="p">,</span> <span class="n">CustomFactor</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="kn">from</span> <span class="nn">zipline.pipeline.filters</span> <span class="kn">import</span> <span class="n">SingleAsset</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="kn">from</span> <span class="nn">zipline.pipeline.factors</span> <span class="kn">import</span> <span class="n">RSI</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="kn">from</span> <span class="nn">zipline.pipeline.data</span> <span class="kn">import</span> <span class="n">TQAltDataSet</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="kn">from</span> <span class="nn">zipline.finance</span> <span class="kn">import</span> <span class="n">slippage</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="kn">from</span> <span class="nn">zipline.TQresearch.tej_pipeline</span> <span class="kn">import</span> <span class="n">run_pipeline</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a><span class="c1"># 設定log顯示方式</span>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a><span class="n">log_handler</span> <span class="o">=</span> <span class="n">StderrHandler</span><span class="p">(</span><span class="n">format_string</span><span class="o">=</span><span class="s1">&#39;[{record.time:%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1">}]: &#39;</span> <span class="o">+</span>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>                            <span class="s1">&#39;</span><span class="si">{record.level_name}</span><span class="s1">: </span><span class="si">{record.func_name}</span><span class="s1">: </span><span class="si">{record.message}</span><span class="s1">&#39;</span><span class="p">,</span>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a>                            <span class="n">level</span><span class="o">=</span><span class="n">INFO</span><span class="p">)</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a><span class="n">log_handler</span><span class="o">.</span><span class="n">push_application</span><span class="p">()</span>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a><span class="n">log</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="s1">&#39;Algorithm&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kn">import</span> <span class="nn">warnings</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</code></pre></div>
<p><span id="Pipeline"></span></p>
<h1 id="5-pipeline">5. Pipeline</h1>
<p>取得<code>Market_Cap_Dollars</code>（市值）資料</p>
<p><a href="#menu">Return to Menu</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Market_Cap_Dollars&#39;</span><span class="p">]</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    <span class="n">fields</span> <span class="o">+=</span> <span class="n">i</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>    <span class="n">fields</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fields</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1"># Ingest Fundamental Bundle</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="err">!</span><span class="n">zipline</span> <span class="n">ingest</span> <span class="o">-</span><span class="n">b</span> <span class="n">fundamentals</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Currently used TEJ API key call quota 83/9223372036854775807 (0.0%)
Currently used TEJ API key data quota 2298569/9223372036854775807 (0.0%)


[2024-03-13 02:40:54.272410] INFO: zipline.data.bundles.core: Ingesting fundamentals.
[2024-03-13 02:41:05.038363] INFO: zipline.data.bundles.core: Ingest fundamentals successfully.
</code></pre></div>
<p><span id="APIReference"></span></p>
<h1 id="6-api-reference">6. API Reference</h1>
<p><a href="#menu">Return to Menu</a></p>
<h3 id="class-ziplinealgopipeline_algotargetpercentpipealgo"><strong>class zipline.algo.pipeline_algo.<font color=DeepPink>TargetPercentPipeAlgo</font></strong></h3>
<p><em>(self, bundle_name='tquant', start_session=None, end_session=None, trading_calendar=get_calendar('TEJ_XTAI'),</em></p>
<p><em>capital_base=1e7, data_frequency='daily', tradeday=None, rebalance_date_rule=None, stocklist=None, benchmark='IR0001',</em> </p>
<p><em>zero_treasury_returns=True, slippage_model=slippage.VolumeShareSlippage(volume_limit=0.025, price_impact=0.1),</em></p>
<p><em>commission_model=commission.Custom_TW_Commission(min_trade_cost=20, discount = 1.0, tax = 0.003), max_leverage=0.8,</em> </p>
<p><em>limit_buy_multiplier=None, limit_sell_multiplier=None, allow_short=False, cancel_datedelta=None, custom_weight=False,</em></p>
<p><em>custom_loader=None, pipeline=None, analyze=None, record_vars=None, get_record_vars=False, get_transaction_detail=False,</em></p>
<p><em>order_filling_policy='next_bar')</em></p>
<p>利用pipeline提供的買賣清單與持股權重進行定期再平衡的演算法。必要參數僅有<code>pipeline</code>。</p>
<h4 id="parameters">Parameters:</h4>
<ul>
<li>
<p><strong>bundle_name</strong> (<em>str, optional</em>)－bundle名稱。預設是 <strong><code>'tquant'</code></strong>。  </p>
</li>
<li>
<p><strong>start_session</strong> (<em>pd.Timestamp or datetime, optional</em>)－回測起始日期。預設是<strong>bundle中最早的資料日期</strong>。  </p>
</li>
<li>
<p><strong>end_session</strong> (<em>pd.Timestamp or datetime, optional</em>)－回測結束日期。預設是<strong>bundle中最晚的資料日期</strong>。  </p>
</li>
<li>
<p><strong>trading_calendar</strong> (<em>TradingCalendar, optional</em>)－</p>
</li>
<li>設置交易日曆。預設是 <strong><code>get_calendar('TEJ_XTAI')</code></strong>。</li>
<li>
<p>TradingCalendar：<code>zipline.utils.calendar_utils.TradingCalendar</code>。  </p>
</li>
<li>
<p><strong>capital_base</strong> (<em>float, optional</em>)－初始資金額度。預設是<strong>一千萬</strong>。  </p>
</li>
<li>
<p><strong>data_frequency</strong> (<em>{'daily', 'minute'}, optional</em>)－資料頻率，目前僅支援日頻率 <strong><code>'daily'</code></strong>。  </p>
</li>
<li>
<p><strong>tradeday</strong> (<em>list[str] or list[pd.Timestamp] or pd.DatetimeIndex, optional</em>)－</p>
</li>
<li>交易日期清單，限制只能在這個清單中的日期進行交易。預設是<strong>None</strong>，代表<strong>每日</strong>都交易。</li>
<li>
<p><code>rebalance_date_rule</code>與<code>tradeday</code>請擇一設定，若兩者皆設定，則會以<code>rebalance_date_rule</code>為主。  </p>
</li>
<li>
<p><strong>rebalance_date_rule</strong>(<em>EventRule, optional</em>)－</p>
</li>
<li>交易頻率，設定固定的交易頻率。預設是<strong>None</strong>，代表<strong>每日</strong>都交易。</li>
<li><code>rebalance_date_rule</code>與<code>tradeday</code>請擇一設定，若兩者皆設定，則會以<code>rebalance_date_rule</code>為主。</li>
<li>
<p>EventRule：<code>zipline.utils.events.EventRule</code>。可使用的<code>rebalance_date_rule</code>參考<a href="#date_rules">zipline.api.date_rules</a>。  </p>
</li>
<li>
<p><strong>stocklist</strong> (<em>list[str], optional</em>)－交易清單，限制只能交易這個清單中的股票。預設是<strong>None</strong>，代表使用所有bundle中的股票。  </p>
</li>
<li>
<p><strong>benchmark</strong> (<em>str, optional</em>)－指數名稱，用來與投資組合報酬率比較。預設是<code>'IR0001'</code>，代表<strong>台灣發行量加權股價報酬指數</strong>。  </p>
</li>
<li>
<p><strong>zero_treasury_returns</strong> (<em>bool, optional</em>)－</p>
</li>
<li>是否將無風險利率設定為0，預設是<strong>True</strong>，代表設定為0。因此使用<code>algo.run()</code>產出的回測報表中，<code>treasury_return</code>與<code>treasury_period_return</code>皆會是0。</li>
<li>
<p>若設定為<strong>False</strong>，則會<font color=DeepPink>耗費額外API流量</font>，並取得第一銀行一年期定存利率作為無風險利率。  </p>
</li>
<li>
<p><strong>slippage_model</strong> (<em>SlippageModel, optional</em>)－</p>
</li>
<li>設定滑價模型。預設為<code>slippage.VolumeShareSlippage(volume_limit=0.025, price_impact=0.1)</code>。可使用的模型參考：<a href="https://github.com/tejtw/TQuant-Lab/blob/main/lecture/Zipline%20Slippage.ipynb">lecture/Zipline Slippage.ipynb</a></li>
<li>
<p>SlippageModel：<code>zipline.finance.slippage.SlippageModel</code>。</p>
</li>
<li>
<p><strong>commission_model</strong> (<em>CommissionModel, optional</em>)－</p>
</li>
<li>設定手續費模型。預設為<code>commission.Custom_TW_Commission(min_trade_cost=20, discount=1.0, tax = 0.003)</code>。可使用的模型參考：<a href="https://github.com/tejtw/TQuant-Lab/blob/main/lecture/Zipline%20Commission%20Models.ipynb">lecture/Zipline Commission Models.ipynb</a></li>
<li>
<p>CommissionModel：<code>zipline.finance.commission.CommissionModel</code></p>
</li>
<li>
<p><strong>max_leverage</strong> (<em>float, optional</em>)－槓桿限制，預設 = <strong>0.8</strong>。  </p>
</li>
<li>
<p><strong>limit_buy_multiplier</strong> (<em>float, optional</em>)－</p>
</li>
<li>買進／回補時的limit_price乘數，若有提供則limit_price = 下單時最近一筆收盤價 * <code>limit_buy_multiplier</code>。</li>
<li>
<p>預設為<strong>None</strong>，代表<strong>不設定</strong>買進／回補時的limit_price。  </p>
</li>
<li>
<p><strong>limit_sell_multiplier</strong> (<em>float, optional</em>)－</p>
</li>
<li>賣出／放空時的limit_price乘數，若有提供則limit_price = 下單時最近一筆收盤價 * <code>limit_sell_multiplier</code>。</li>
<li>
<p>預設為<strong>None</strong>，代表<strong>不設定</strong>賣出／放空時的limit_price。  </p>
</li>
<li>
<p><strong>allow_short</strong> (<em>bool, optional</em>)－是否允許放空股票，預設為<strong>False</strong>，代表僅能做多。若設定為<strong>True</strong>，則pipeline中需要有<code>shorts</code>欄位。  </p>
</li>
<li>
<p><strong>cancel_datedelta</strong> (<em>int, optional</em>)－訂單幾天內未完全成交就取消。預設是在<strong>下一次再平衡</strong>時取消。 </p>
</li>
<li>
<p><strong>custom_weight</strong> (<em>bool, optional</em>)－</p>
</li>
<li>是否要使用自訂的加權權數，預設為<strong>False</strong>，代表不使用（即等權重加權）。</li>
<li>
<p>若設定為<strong>True</strong>，則pipeline中需要有<code>long_weights</code>（若<code>allow_short</code>=True，則也須有<code>short_weights</code>）欄位。</p>
</li>
<li>
<p><strong>custom_loader</strong> (<em>PipelineLoader , optional</em>)－</p>
</li>
<li>用來取得價量以外資料，預設是<strong>None</strong>，代表不使用價量、<code>TQDataSet</code>與<code>TQAltDataSet</code>以外資料。</li>
<li>TQDataSet：<code>zipline.pipeline.data.TQDataSet</code></li>
<li>TQAltDataSet：<code>zipline.pipeline.data.TQAltDataSet</code></li>
<li>
<p>目前支援的<code>PipelineLoader</code>：</p>
<ul>
<li>DataFrameLoader（<code>zipline.pipeline.loaders.frame.DataFrameLoader</code>）。</li>
</ul>
</li>
<li>
<p><strong>pipeline</strong> (<em>Pipeline</em>)－</p>
</li>
<li>要用來產出交易清單或權重的pipeline，為<font color=DeepPink><strong>必要參數</strong></font>。</li>
<li>
<p>Pipeline：<code>zipline.pipeline.Pipeline</code></p>
</li>
<li>
<p><strong>analyze</strong> (<em>callable[(context, pd.DataFrame) -&gt; None], optional</em>)－</p>
</li>
<li>傳入<code>analyze</code>函式以用於回測，函式中必須要有<code>context</code>與<code>perf</code>參數，預設是<strong>None</strong>。</li>
<li>
<p>此函式在<strong>回測結束</strong>時被一次性呼叫，並繪製自訂圖表。</p>
</li>
<li>
<p><strong>record_vars</strong> (<em>callable[(context, BarData) -&gt; None], optional</em>)－</p>
</li>
<li>傳入<code>record_vars</code>函式以用於回測，函式中必須要有<code>context</code>與<code>data</code>參數，預設是<strong>None</strong>。</li>
<li>
<p>此函式在<strong>每個交易日結束</strong>時被呼叫，並把指定資料紀錄於回測結果的DataFrame中。</p>
</li>
<li>
<p><strong>get_record_vars</strong> (<em>bool, optional</em>)－</p>
</li>
<li>是否產出<code>record_vars</code>中<code>record</code>方法所記錄的變數，預設為<strong>False</strong>，代表不產出。</li>
<li>
<p>若設定為<strong>True</strong>，則可用<code>algo.dict_record_vars</code>取出。</p>
</li>
<li>
<p><strong>get_transaction_detail</strong> (<em>bool, optional</em>)－</p>
</li>
<li>是否產出交易結果，預設為<strong>False</strong>，代表不產出。</li>
<li>
<p>若設定為<strong>True</strong>，則可用<code>algo.positions</code>、<code>algo.transactions</code>、<code>algo.orders</code>方式取出交易結果。</p>
</li>
<li>
<p><strong>order_filling_policy</strong> (<em>{'next_bar','current_bar'}, optional</em>)－</p>
</li>
<li>設定交易方式，預設為<strong>next_bar</strong>，代表當天收盤後下單，隔一日收盤前成交，也就是原先的回測方式。</li>
<li>若要當天開盤前下單，收盤前成交，則需指定設定為<strong>current_bar</strong>。</li>
</ul>
<h4 id="returns">Returns:</h4>
<div class="highlight"><pre><span></span><code>algo
</code></pre></div>
<h4 id="return-type">Return type:</h4>
<div class="highlight"><pre><span></span><code>zipline.algo.pipeline_algo.TargetPercentPipeAlgo
</code></pre></div>
<p><br></p>
<p><br/></p>
<p><strong><font color=DeepPink>run</font>()</strong></p>
<blockquote>
<p>執行演算法</p>
<p><strong>Returns:</strong>
- perf（回測報表）</p>
<p><strong>Return type:</strong>
- pd.DataFrame</p>
</blockquote>
<p><span id="date_rules"></span></p>
<h3 id="class-ziplineapidate_rules"><strong>class zipline.api.<font color=DeepPink>date_rules</font></strong></h3>
<p><a href="#menu">Return to Menu</a></p>
<ul>
<li>為Factory API，主要用來傳入<code>zipline.api.schedule_function</code>的<code>date_rule</code>參數中。用來決定要以何種頻率觸發某項規則。</li>
<li>使用前請先import：<code>from zipline.api import date_rules</code>。</li>
</ul>
<hr />
<p><em>static</em> <strong><font color=DeepPink>every_day</font></strong>()</p>
<blockquote>
<p>每日觸發某項規則。</p>
<p><strong>Returns:</strong>
- rule</p>
<p><strong>Return type:</strong>
- zipline.utils.events.EventRule</p>
</blockquote>
<p><br></p>
<p><em>static</em> <strong><font color=DeepPink>month_end</font></strong>(days_offset=0)</p>
<blockquote>
<p>每個月底觸發某項規則，並可以選擇性的新增一個偏移量。</p>
<p><strong>Parameters:</strong>
- <strong>days_offset</strong>(<em>int , optional</em>)：
  - 在月底之前的第幾個交易日（由0開始計算）觸發某項規則。預設值是0，即在月底的最後一個交易日觸發。
  - days_offset只能介於0~22之間。 </p>
<p><strong>Returns:</strong>
- rule</p>
<p><strong>Return type:</strong>
- zipline.utils.events.EventRule</p>
</blockquote>
<p><br></p>
<p><em>static</em> <strong><font color=DeepPink>month_start</font></strong>(days_offset=0)</p>
<blockquote>
<p>每個月初觸發某項規則，並可以選擇性的新增一個偏移量。</p>
<p><strong>Parameters:</strong>
- <strong>days_offset</strong>(<em>int , optional</em>)：
  - 在月初之後的第幾個交易日（由0開始計算）才觸發某項規則。預設值是0，即在月初的第一個交易日觸發。
  - days_offset只能介於0~22之間。 </p>
<p><strong>Returns:</strong>
- rule</p>
<p><strong>Return type:</strong>
- zipline.utils.events.EventRule</p>
</blockquote>
<p><br></p>
<p><em>static</em> <strong><font color=DeepPink>week_end</font></strong>(days_offset=0)</p>
<blockquote>
<p>在每周最後一個交易日觸發某項規則，並可以選擇性的新增一個偏移量。</p>
<p><strong>Parameters:</strong>
- <strong>days_offset</strong>(<em>int , optional</em>)：
  - 在每周倒數第幾個交易日（由0開始計算）觸發某項規則。預設值是0，即在每周的最後一個交易日觸發。
  - days_offset只能介於0~4之間。 </p>
<p><strong>Returns:</strong>
- rule</p>
<p><strong>Return type:</strong>
- zipline.utils.events.EventRule</p>
</blockquote>
<p><br></p>
<p><em>static</em> <strong><font color=DeepPink>week_start</font></strong>(days_offset=0)</p>
<blockquote>
<p>在每周的第一個交易日觸發某項規則，並可以選擇性的新增一個偏移量。</p>
<p><strong>Parameters:</strong>
- <strong>days_offset</strong>(<em>int , optional</em>)：
  - 在每周的第幾個交易日（由0開始計算）才觸發某項規則。預設值是0，即在每周的第一個交易日觸發。
  - days_offset只能介於0~4之間。</p>
<p><strong>Returns:</strong>
- rule</p>
<p><strong>Return type:</strong>
- zipline.utils.events.EventRule</p>
</blockquote>
<p><span id="Examples"></span></p>
<h1 id="7-examples">7. Examples</h1>
<p><a href="#menu">Return to Menu</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kn">from</span> <span class="nn">zipline.utils.algo_instance</span> <span class="kn">import</span> <span class="n">get_algo_instance</span><span class="p">,</span> <span class="n">set_algo_instance</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="kn">from</span> <span class="nn">zipline.algo.pipeline_algo</span> <span class="kn">import</span> <span class="n">TargetPercentPipeAlgo</span>
</code></pre></div>
<p><span id="Case1"></span></p>
<h2 id="case-1-start_sessionend_session">Case 1 調整start_session與end_session</h2>
<p><a href="#menu">Return to Menu</a></p>
<p>僅調整<code>start_session</code>與<code>end_session</code>。其餘保持預設值。</p>
<p>以下設定pipeline（<code>make_pipeline()</code>），並定義<code>longs</code>欄位用來判斷須持有的股票。在<code>longs</code>欄位中要持有的股票標記為True，反之標記為False。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kn">from</span> <span class="nn">zipline.data</span> <span class="kn">import</span> <span class="n">bundles</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="n">bundle</span> <span class="o">=</span> <span class="n">bundles</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">bundle_name</span><span class="p">)</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="k">def</span> <span class="nf">make_pipeline</span><span class="p">():</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>    <span class="n">rsi</span> <span class="o">=</span> <span class="n">RSI</span><span class="p">()</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>    <span class="n">longs</span> <span class="o">=</span> <span class="n">rsi</span><span class="o">.</span><span class="n">top</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">SingleAsset</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">asset_finder</span><span class="o">.</span><span class="n">lookup_symbol</span><span class="p">(</span><span class="s1">&#39;IR0001&#39;</span><span class="p">,</span> <span class="n">as_of_date</span><span class="o">=</span><span class="kc">None</span><span class="p">)))</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>    <span class="k">return</span> <span class="n">Pipeline</span><span class="p">(</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>        <span class="n">columns</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>            <span class="s2">&quot;longs&quot;</span> <span class="p">:</span> <span class="n">longs</span><span class="p">,</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>        <span class="p">}</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>    <span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">algo_start</span> <span class="o">=</span> <span class="s1">&#39;2023-09-21&#39;</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="n">algo_start_dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">algo_start</span><span class="p">,</span> <span class="n">tz</span> <span class="o">=</span> <span class="n">tz</span><span class="p">)</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="n">result</span> <span class="o">=</span> <span class="n">run_pipeline</span><span class="p">(</span><span class="n">make_pipeline</span><span class="p">(),</span> <span class="n">algo_start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="n">result</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;longs == True&#39;</span><span class="p">)</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>longs</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">2023-09-22 00:00:00+00:00</th>
      <th>Equity(6 [1590])</th>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(24 [2603])</th>
      <td>True</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">2023-09-25 00:00:00+00:00</th>
      <th>Equity(25 [2609])</th>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(34 [2886])</th>
      <td>True</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">2023-09-26 00:00:00+00:00</th>
      <th>Equity(33 [2885])</th>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(34 [2886])</th>
      <td>True</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">2023-09-27 00:00:00+00:00</th>
      <th>Equity(25 [2609])</th>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(34 [2886])</th>
      <td>True</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">2023-09-28 00:00:00+00:00</th>
      <th>Equity(6 [1590])</th>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(34 [2886])</th>
      <td>True</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">2023-10-02 00:00:00+00:00</th>
      <th>Equity(24 [2603])</th>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(34 [2886])</th>
      <td>True</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">2023-10-03 00:00:00+00:00</th>
      <th>Equity(6 [1590])</th>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(14 [2327])</th>
      <td>True</td>
    </tr>
  </tbody>
</table>
</div>

<h3 id="_1">執行演算法</h3>
<ol>
<li>實體化<code>TargetPercentPipeAlgo</code>並命名為<code>algo</code>。</li>
<li>設定演算法：<code>set_algo_instance(algo)</code></li>
<li>執行演算法，並產出回測報表<code>stats</code>（<em>pd.DataFrame</em>）：<code>stats = algo.run()</code></li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="n">algo</span> <span class="o">=</span> <span class="n">TargetPercentPipeAlgo</span><span class="p">(</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>                     <span class="n">start_session</span><span class="o">=</span><span class="n">algo_start_dt</span><span class="p">,</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>                     <span class="n">end_session</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>                     <span class="n">pipeline</span><span class="o">=</span><span class="n">make_pipeline</span><span class="p">,</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="p">)</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="c1"># set_algo_instance</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="n">set_algo_instance</span><span class="p">(</span><span class="n">algo</span><span class="p">)</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="c1"># run</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="n">stats</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>[2024-03-13 02:41:05.491033]: INFO: rebalance: Cancel_order: current time: 2023-09-22 , created: 2023-09-21 , asset: Equity(46 [4904]), amount: 55478 , filled: 51900
[2024-03-13 02:41:05.499675]: INFO: rebalance: Cancel_order: current time: 2023-09-25 , created: 2023-09-25 , asset: Equity(46 [4904]), amount: -14450 , filled: 0
[2024-03-13 02:41:05.504262]: INFO: earn_dividends: Equity(6 [1590]), cash_dividend amount: 13.43905496, pay_date: 2023-10-30, div_owed: 54616.31935744
[2024-03-13 02:41:05.505924]: INFO: handle_split: after split: asset: Equity(6 [1590]), amount: 4062, cost_basis: 982.73, last_sale_price: 981.0
[2024-03-13 02:41:05.506228]: INFO: handle_split: returning cash: 643.94
[2024-03-13 02:41:05.549641]: INFO: handle_simulation_end: Simulated 8 trading days
first open: 2023-09-21 01:01:00+00:00
last close: 2023-10-03 05:30:00+00:00
</code></pre></div>
<p>查看演算法中的參數設定</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="n">algo</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>TargetPercentPipeAlgo(
    sim_params = 
SimulationParameters(
    start_session=2023-09-21 00:00:00+00:00,
    end_session=2023-10-03 00:00:00+00:00,
    capital_base=10000000.0,
    data_frequency=daily,
    emission_rate=daily,
    first_open=2023-09-21 01:01:00+00:00,
    last_close=2023-10-03 05:30:00+00:00,
    trading_calendar=&lt;exchange_calendars.exchange_calendar_tejxtai.TEJ_XTAIExchangeCalendar object at 0x0000017B415030D0&gt;
),
    benchmark = IR0001,
    zero treasury returns or not（if &quot;True&quot; then treasury returns = 0）= True,
    max_leverage = 0.8,
    slippage model used = VolumeShareSlippage(
    volume_limit=0.025,
    price_impact=0.1),
    commission_model = Custom_TW_Commission(min_trade_cost=20.0),
    liquidity_risk_management_rule = None,
    order_filling_policy = next_bar,
    adjust amount or not = False,
    limit_buy_multiplier = None,
    limit_sell_multiplier = None,
    allow short or not（if &quot;False&quot; then long only）= False,
    use custom weight or not（if not then &quot;equal weighted&quot;）= False,
    cancel_datedelta（if &quot;None&quot; then cancel open orders at next rebalance date）= None,
    stocklist = [&#39;1101&#39;, &#39;1216&#39;, &#39;1301&#39;, &#39;1303&#39;, &#39;1326&#39;, &#39;1402&#39;, &#39;1590&#39;, &#39;1605&#39;, &#39;2002&#39;, &#39;2207&#39;, &#39;2301&#39;, &#39;2303&#39;, &#39;2308&#39;, &#39;2317&#39;, &#39;2327&#39;, &#39;2330&#39;, &#39;2345&#39;, &#39;2357&#39;, &#39;2379&#39;, &#39;2382&#39;, &#39;2395&#39;, &#39;2408&#39;, &#39;2412&#39;, &#39;2454&#39;, &#39;2603&#39;, &#39;2609&#39;, &#39;2615&#39;, &#39;2801&#39;, &#39;2880&#39;, &#39;2881&#39;, &#39;2882&#39;, &#39;2883&#39;, &#39;2884&#39;, &#39;2885&#39;, &#39;2886&#39;, &#39;2887&#39;, &#39;2890&#39;, &#39;2891&#39;, &#39;2892&#39;, &#39;2912&#39;, &#39;3008&#39;, &#39;3034&#39;, &#39;3037&#39;, &#39;3045&#39;, &#39;3231&#39;, &#39;3711&#39;, &#39;4904&#39;, &#39;4938&#39;, &#39;5871&#39;, &#39;5876&#39;, &#39;5880&#39;, &#39;6415&#39;, &#39;6505&#39;, &#39;6669&#39;, &#39;9910&#39;, &#39;IR0001&#39;],
    tradeday = DatetimeIndex([&#39;2023-09-21 00:00:00+00:00&#39;, &#39;2023-09-22 00:00:00+00:00&#39;,
               &#39;2023-09-25 00:00:00+00:00&#39;, &#39;2023-09-26 00:00:00+00:00&#39;,
               &#39;2023-09-27 00:00:00+00:00&#39;, &#39;2023-09-28 00:00:00+00:00&#39;,
               &#39;2023-10-02 00:00:00+00:00&#39;, &#39;2023-10-03 00:00:00+00:00&#39;],
              dtype=&#39;datetime64[ns, UTC]&#39;, freq=&#39;C&#39;),
    rebalance_date_rule（If the &quot;rebalance_date_rule&quot; parameter is provided, then ignore the &quot;tradeday&quot; parameter.&quot;） 
    = None,
    get transaction detail or not = False,
    blotter = SimulationBlotter(
    slippage_models={&lt;class &#39;zipline.assets._assets.Equity&#39;&gt;: VolumeShareSlippage(
    volume_limit=0.025,
    price_impact=0.1), &lt;class &#39;zipline.assets._assets.Future&#39;&gt;: VolatilityVolumeShare(volume_limit=0.05, eta=&lt;varies&gt;)},
    commission_models={&lt;class &#39;zipline.assets._assets.Equity&#39;&gt;: Custom_TW_Commission(min_trade_cost=20.0), &lt;class &#39;zipline.assets._assets.Future&#39;&gt;: PerContract(cost_per_contract=0.85, exchange_fee=&lt;varies&gt;, min_trade_cost=0)},
    open_orders=defaultdict(&lt;class &#39;list&#39;&gt;, {Equity(24 [2603]): [Order({&#39;id&#39;: &#39;307a0683715641db990a5ac44c1077bf&#39;, &#39;dt&#39;: Timestamp(&#39;2023-10-03 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-10-03 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: -33982, &#39;filled&#39;: 0, &#39;commission&#39;: 0, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(24 [2603]), &#39;status&#39;: &lt;ORDER_STATUS.OPEN: 0&gt;})], Equity(34 [2886]): [Order({&#39;id&#39;: &#39;e5f6a3c19d2d4465ad5f0592eb6578c5&#39;, &#39;dt&#39;: Timestamp(&#39;2023-10-03 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-10-03 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: -102579, &#39;filled&#39;: 0, &#39;commission&#39;: 0, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(34 [2886]), &#39;status&#39;: &lt;ORDER_STATUS.OPEN: 0&gt;})], Equity(6 [1590]): [Order({&#39;id&#39;: &#39;4545f498f583429d8c867307ac34f9d5&#39;, &#39;dt&#39;: Timestamp(&#39;2023-10-03 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-10-03 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: 3846, &#39;filled&#39;: 0, &#39;commission&#39;: 0, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(6 [1590]), &#39;status&#39;: &lt;ORDER_STATUS.OPEN: 0&gt;})], Equity(14 [2327]): [Order({&#39;id&#39;: &#39;11c46077c2b549c9ab4c156f697053f6&#39;, &#39;dt&#39;: Timestamp(&#39;2023-10-03 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-10-03 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: 7381, &#39;filled&#39;: 0, &#39;commission&#39;: 0, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(14 [2327]), &#39;status&#39;: &lt;ORDER_STATUS.OPEN: 0&gt;})]}),
    orders={&#39;bdcb9758340444948f3af991c6b2478b&#39;: Order({&#39;id&#39;: &#39;bdcb9758340444948f3af991c6b2478b&#39;, &#39;dt&#39;: Timestamp(&#39;2023-09-22 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-09-21 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: 106951, &#39;filled&#39;: 106951, &#39;commission&#39;: 5761, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(34 [2886]), &#39;status&#39;: &lt;ORDER_STATUS.FILLED: 1&gt;}), &#39;acc3c2d89f8e48c3bc42daa9e8d81560&#39;: Order({&#39;id&#39;: &#39;acc3c2d89f8e48c3bc42daa9e8d81560&#39;, &#39;dt&#39;: Timestamp(&#39;2023-09-22 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-09-21 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: 55478, &#39;filled&#39;: 51900, &#39;commission&#39;: 5333, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(46 [4904]), &#39;status&#39;: &lt;ORDER_STATUS.CANCELLED: 2&gt;}), &#39;91e9060255b8480c88251ce5ed781b49&#39;: Order({&#39;id&#39;: &#39;91e9060255b8480c88251ce5ed781b49&#39;, &#39;dt&#39;: Timestamp(&#39;2023-09-25 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-09-22 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: -106951, &#39;filled&#39;: -106951, &#39;commission&#39;: 17985, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(34 [2886]), &#39;status&#39;: &lt;ORDER_STATUS.FILLED: 1&gt;}), &#39;71a11f3296354834956e3a801721c806&#39;: Order({&#39;id&#39;: &#39;71a11f3296354834956e3a801721c806&#39;, &#39;dt&#39;: Timestamp(&#39;2023-09-25 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-09-22 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: -51900, &#39;filled&#39;: -37450, &#39;commission&#39;: 12081, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(46 [4904]), &#39;status&#39;: &lt;ORDER_STATUS.CANCELLED: 2&gt;}), &#39;2777dbff1bbd48188466187cc31e69d3&#39;: Order({&#39;id&#39;: &#39;2777dbff1bbd48188466187cc31e69d3&#39;, &#39;dt&#39;: Timestamp(&#39;2023-09-25 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-09-22 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: 34894, &#39;filled&#39;: 34894, &#39;commission&#39;: 5768, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(24 [2603]), &#39;status&#39;: &lt;ORDER_STATUS.FILLED: 1&gt;}), &#39;1ec8dcf092f84220a87650c5db8959fc&#39;: Order({&#39;id&#39;: &#39;1ec8dcf092f84220a87650c5db8959fc&#39;, &#39;dt&#39;: Timestamp(&#39;2023-09-25 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-09-22 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: 4064, &#39;filled&#39;: 4064, &#39;commission&#39;: 5682, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(6 [1590]), &#39;status&#39;: &lt;ORDER_STATUS.FILLED: 1&gt;}), &#39;f39524a1508142c9af7306307956f8e9&#39;: Order({&#39;id&#39;: &#39;f39524a1508142c9af7306307956f8e9&#39;, &#39;dt&#39;: Timestamp(&#39;2023-09-25 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-09-25 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: -14450, &#39;filled&#39;: 0, &#39;commission&#39;: 0, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(46 [4904]), &#39;status&#39;: &lt;ORDER_STATUS.CANCELLED: 2&gt;}), &#39;dc7128121a9d40d182ec3d9d4d465492&#39;: Order({&#39;id&#39;: &#39;dc7128121a9d40d182ec3d9d4d465492&#39;, &#39;dt&#39;: Timestamp(&#39;2023-09-26 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-09-25 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: -34894, &#39;filled&#39;: -34894, &#39;commission&#39;: 17835, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(24 [2603]), &#39;status&#39;: &lt;ORDER_STATUS.FILLED: 1&gt;}), &#39;ceec5c24911044baba3d8c0abab96960&#39;: Order({&#39;id&#39;: &#39;ceec5c24911044baba3d8c0abab96960&#39;, &#39;dt&#39;: Timestamp(&#39;2023-09-26 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-09-25 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: -14450, &#39;filled&#39;: -14450, &#39;commission&#39;: 4649, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(46 [4904]), &#39;status&#39;: &lt;ORDER_STATUS.FILLED: 1&gt;}), &#39;c55dc4e5611246698718518b5ad46860&#39;: Order({&#39;id&#39;: &#39;c55dc4e5611246698718518b5ad46860&#39;, &#39;dt&#39;: Timestamp(&#39;2023-09-26 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-09-25 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: -4062, &#39;filled&#39;: -4062, &#39;commission&#39;: 17221, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(6 [1590]), &#39;status&#39;: &lt;ORDER_STATUS.FILLED: 1&gt;}), &#39;5ca0608910f8443a9c2ec23de6c1ab6f&#39;: Order({&#39;id&#39;: &#39;5ca0608910f8443a9c2ec23de6c1ab6f&#39;, &#39;dt&#39;: Timestamp(&#39;2023-09-26 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-09-25 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: 87136, &#39;filled&#39;: 87136, &#39;commission&#39;: 5706, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(25 [2609]), &#39;status&#39;: &lt;ORDER_STATUS.FILLED: 1&gt;}), &#39;aafbcc931d8e4f87adb21686aeb0f227&#39;: Order({&#39;id&#39;: &#39;aafbcc931d8e4f87adb21686aeb0f227&#39;, &#39;dt&#39;: Timestamp(&#39;2023-09-26 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-09-25 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: 105366, &#39;filled&#39;: 105366, &#39;commission&#39;: 5684, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(34 [2886]), &#39;status&#39;: &lt;ORDER_STATUS.FILLED: 1&gt;}), &#39;153b35815aa44224aebbd79d673403b2&#39;: Order({&#39;id&#39;: &#39;153b35815aa44224aebbd79d673403b2&#39;, &#39;dt&#39;: Timestamp(&#39;2023-09-27 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-09-26 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: -87136, &#39;filled&#39;: -87136, &#39;commission&#39;: 17699, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(25 [2609]), &#39;status&#39;: &lt;ORDER_STATUS.FILLED: 1&gt;}), &#39;b397a24cd315420683b711b7c933abc3&#39;: Order({&#39;id&#39;: &#39;b397a24cd315420683b711b7c933abc3&#39;, &#39;dt&#39;: Timestamp(&#39;2023-09-27 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-09-26 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: 157495, &#39;filled&#39;: 157495, &#39;commission&#39;: 5645, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(33 [2885]), &#39;status&#39;: &lt;ORDER_STATUS.FILLED: 1&gt;}), &#39;2f3a95e39fd840dc8aca520f0c36f6b1&#39;: Order({&#39;id&#39;: &#39;2f3a95e39fd840dc8aca520f0c36f6b1&#39;, &#39;dt&#39;: Timestamp(&#39;2023-09-27 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-09-26 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: -1339, &#39;filled&#39;: -1339, &#39;commission&#39;: 224, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(34 [2886]), &#39;status&#39;: &lt;ORDER_STATUS.FILLED: 1&gt;}), &#39;1ebe571a863a415297cd8aa1bc2b07b9&#39;: Order({&#39;id&#39;: &#39;1ebe571a863a415297cd8aa1bc2b07b9&#39;, &#39;dt&#39;: Timestamp(&#39;2023-09-28 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-09-27 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: -157495, &#39;filled&#39;: -157495, &#39;commission&#39;: 17458, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(33 [2885]), &#39;status&#39;: &lt;ORDER_STATUS.FILLED: 1&gt;}), &#39;432d560b9e99476d846b3675db5b2d44&#39;: Order({&#39;id&#39;: &#39;432d560b9e99476d846b3675db5b2d44&#39;, &#39;dt&#39;: Timestamp(&#39;2023-09-28 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-09-27 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: 85400, &#39;filled&#39;: 85400, &#39;commission&#39;: 5532, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(25 [2609]), &#39;status&#39;: &lt;ORDER_STATUS.FILLED: 1&gt;}), &#39;9fb1d769ef504f44b2dd544653e997c2&#39;: Order({&#39;id&#39;: &#39;9fb1d769ef504f44b2dd544653e997c2&#39;, &#39;dt&#39;: Timestamp(&#39;2023-09-28 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-09-27 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: -51, &#39;filled&#39;: -51, &#39;commission&#39;: 26.0, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(34 [2886]), &#39;status&#39;: &lt;ORDER_STATUS.FILLED: 1&gt;}), &#39;5a76b96aecf749d683699d19b7fc687c&#39;: Order({&#39;id&#39;: &#39;5a76b96aecf749d683699d19b7fc687c&#39;, &#39;dt&#39;: Timestamp(&#39;2023-10-02 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-09-28 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: -85400, &#39;filled&#39;: -85400, &#39;commission&#39;: 16799, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(25 [2609]), &#39;status&#39;: &lt;ORDER_STATUS.FILLED: 1&gt;}), &#39;c2f1f413dea8434f9ef69b9f58c40810&#39;: Order({&#39;id&#39;: &#39;c2f1f413dea8434f9ef69b9f58c40810&#39;, &#39;dt&#39;: Timestamp(&#39;2023-10-02 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-09-28 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: -412, &#39;filled&#39;: -412, &#39;commission&#39;: 70, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(34 [2886]), &#39;status&#39;: &lt;ORDER_STATUS.FILLED: 1&gt;}), &#39;c2c40f199a7f4f7a85e33a6f0fd9c3d7&#39;: Order({&#39;id&#39;: &#39;c2c40f199a7f4f7a85e33a6f0fd9c3d7&#39;, &#39;dt&#39;: Timestamp(&#39;2023-10-02 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-09-28 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: 3988, &#39;filled&#39;: 3988, &#39;commission&#39;: 5712, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(6 [1590]), &#39;status&#39;: &lt;ORDER_STATUS.FILLED: 1&gt;}), &#39;40c0549e04914d8db877272facf233f9&#39;: Order({&#39;id&#39;: &#39;40c0549e04914d8db877272facf233f9&#39;, &#39;dt&#39;: Timestamp(&#39;2023-10-03 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-10-02 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: -3988, &#39;filled&#39;: -3988, &#39;commission&#39;: 17612, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(6 [1590]), &#39;status&#39;: &lt;ORDER_STATUS.FILLED: 1&gt;}), &#39;b990b03de87744508a9bfcbab7e14ba6&#39;: Order({&#39;id&#39;: &#39;b990b03de87744508a9bfcbab7e14ba6&#39;, &#39;dt&#39;: Timestamp(&#39;2023-10-03 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-10-02 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: 33982, &#39;filled&#39;: 33982, &#39;commission&#39;: 5351, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(24 [2603]), &#39;status&#39;: &lt;ORDER_STATUS.FILLED: 1&gt;}), &#39;fcc61389fce5448297c04514a9523155&#39;: Order({&#39;id&#39;: &#39;fcc61389fce5448297c04514a9523155&#39;, &#39;dt&#39;: Timestamp(&#39;2023-10-03 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-10-02 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: -985, &#39;filled&#39;: -985, &#39;commission&#39;: 165, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(34 [2886]), &#39;status&#39;: &lt;ORDER_STATUS.FILLED: 1&gt;}), &#39;307a0683715641db990a5ac44c1077bf&#39;: Order({&#39;id&#39;: &#39;307a0683715641db990a5ac44c1077bf&#39;, &#39;dt&#39;: Timestamp(&#39;2023-10-03 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-10-03 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: -33982, &#39;filled&#39;: 0, &#39;commission&#39;: 0, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(24 [2603]), &#39;status&#39;: &lt;ORDER_STATUS.OPEN: 0&gt;}), &#39;e5f6a3c19d2d4465ad5f0592eb6578c5&#39;: Order({&#39;id&#39;: &#39;e5f6a3c19d2d4465ad5f0592eb6578c5&#39;, &#39;dt&#39;: Timestamp(&#39;2023-10-03 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-10-03 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: -102579, &#39;filled&#39;: 0, &#39;commission&#39;: 0, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(34 [2886]), &#39;status&#39;: &lt;ORDER_STATUS.OPEN: 0&gt;}), &#39;4545f498f583429d8c867307ac34f9d5&#39;: Order({&#39;id&#39;: &#39;4545f498f583429d8c867307ac34f9d5&#39;, &#39;dt&#39;: Timestamp(&#39;2023-10-03 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-10-03 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: 3846, &#39;filled&#39;: 0, &#39;commission&#39;: 0, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(6 [1590]), &#39;status&#39;: &lt;ORDER_STATUS.OPEN: 0&gt;}), &#39;11c46077c2b549c9ab4c156f697053f6&#39;: Order({&#39;id&#39;: &#39;11c46077c2b549c9ab4c156f697053f6&#39;, &#39;dt&#39;: Timestamp(&#39;2023-10-03 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;reason&#39;: None, &#39;created&#39;: Timestamp(&#39;2023-10-03 05:30:00+0000&#39;, tz=&#39;UTC&#39;), &#39;amount&#39;: 7381, &#39;filled&#39;: 0, &#39;commission&#39;: 0, &#39;stop&#39;: None, &#39;limit&#39;: None, &#39;stop_reached&#39;: False, &#39;limit_reached&#39;: False, &#39;sid&#39;: Equity(14 [2327]), &#39;status&#39;: &lt;ORDER_STATUS.OPEN: 0&gt;})},
    new_orders=[],
    current_dt=2023-10-03 05:30:00+00:00),
    recorded_vars = {})
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="n">stats</span><span class="o">.</span><span class="n">T</span>
</code></pre></div>
<div style="overflow-x: auto; white-space: nowrap;">
    <table border="1" class="dataframe">
      <thead>
        <tr style="text-align: right;">
          <th></th>
          <th>2023-09-21 13:30:00+08:00</th>
          <th>2023-09-22 13:30:00+08:00</th>
          <th>2023-09-25 13:30:00+08:00</th>
          <th>2023-09-26 13:30:00+08:00</th>
          <th>2023-09-27 13:30:00+08:00</th>
          <th>2023-09-28 13:30:00+08:00</th>
          <th>2023-10-02 13:30:00+08:00</th>
          <th>2023-10-03 13:30:00+08:00</th>
        </tr>
      </thead>
      <tbody>
        <tr><th>period_open</th><td>2023-09-21 09:01:00+08:00</td><td>2023-09-22 09:01:00+08:00</td><td>2023-09-25 09:01:00+08:00</td><td>2023-09-26 09:01:00+08:00</td><td>2023-09-27 09:01:00+08:00</td><td>2023-09-28 09:01:00+08:00</td><td>2023-10-02 09:01:00+08:00</td><td>2023-10-03 09:01:00+08:00</td></tr>
        <tr><th>period_close</th><td>2023-09-21 13:30:00+08:00</td><td>2023-09-22 13:30:00+08:00</td><td>2023-09-25 13:30:00+08:00</td><td>2023-09-26 13:30:00+08:00</td><td>2023-09-27 13:30:00+08:00</td><td>2023-09-28 13:30:00+08:00</td><td>2023-10-02 13:30:00+08:00</td><td>2023-10-03 13:30:00+08:00</td></tr>
        <tr><th>starting_cash</th><td>10000000.0</td><td>10000000.0</td><td>2203905.142427</td><td>921903.876036</td><td>1851480.446535</td><td>1916878.693942</td><td>1959492.659321</td><td>1740449.09152</td></tr>
        <tr><th>ending_cash</th><td>10000000.0</td><td>2203905.142427</td><td>921903.876036</td><td>1851480.446535</td><td>1916878.693942</td><td>1959492.659321</td><td>1740449.09152</td><td>1979378.550691</td></tr>
        <tr><th>portfolio_value</th><td>10000000.0</td><td>9988642.942427</td><td>10009796.876036</td><td>9843482.746535</td><td>9799695.843942</td><td>9760817.859321</td><td>9642395.49152</td><td>9596488.900691</td></tr>
        <tr><th>transactions</th><td>[]</td><td>[{'amount': 106951, 'dt': '2023-09-22 13:30:00+08:00'}]</td><td>[{'amount': -37450, 'dt': '2023-09-25 13:30:00+08:00'}]</td><td>[{'amount': -14450, 'dt': '2023-09-26 13:30:00+08:00'}]</td><td>[{'amount': -87136, 'dt': '2023-09-27 13:30:00+08:00'}]</td><td>[{'amount': -157495, 'dt': '2023-09-28 13:30:00+08:00'}]</td><td>[{'amount': -85400, 'dt': '2023-10-02 13:30:00+08:00'}]</td><td>[{'amount': -3988, 'dt': '2023-10-03 13:30:00+08:00'}]</td></tr>
        <tr><th>longs_count</th><td>0</td><td>2</td><td>3</td><td>2</td><td>2</td><td>2</td><td>2</td><td>2</td></tr>
        <tr><th>gross_leverage</th><td>0.0</td><td>0.779359</td><td>0.9079</td><td>0.811908</td><td>0.804394</td><td>0.799249</td><td>0.8195</td><td>0.793739</td></tr>
        <tr><th>sharpe</th><td>NaN</td><td>-11.224972</td><td>3.147118</td><td>-7.232764</td><td>-8.577955</td><td>-9.570898</td><td>-12.063911</td><td>-12.898619</td></tr>
        <tr><th>trading_days</th><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td></tr>
        <tr><th>returns</th><td>0.0</td><td>-0.001136</td><td>0.002118</td><td>-0.016615</td><td>-0.004448</td><td>-0.003967</td><td>-0.012132</td><td>-0.004761</td></tr>
        <tr><th>alpha</th><td>NaN</td><td>-0.223982</td><td>0.114994</td><td>-0.409947</td><td>-0.5193</td><td>-0.56714</td><td>-0.729949</td><td>-0.723783</td></tr>
        <tr><th>beta</th><td>NaN</td><td>-0.076255</td><td>0.064179</td><td>0.468458</td><td>0.415352</td><td>0.385683</td><td>0.052787</td><td>0.044894</td></tr>
      </tbody>
    </table>
</div>

<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="n">positions</span><span class="p">,</span> <span class="n">transactions</span><span class="p">,</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">get_transaction_detail</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="n">transactions</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sid</th>
      <th>symbol</th>
      <th>amount</th>
      <th>dt</th>
      <th>price</th>
      <th>order_id</th>
      <th>asset</th>
      <th>commission</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-09-22 13:30:00+08:00</th>
      <td>34</td>
      <td>2886</td>
      <td>106951</td>
      <td>2023-09-22 13:30:00+08:00</td>
      <td>37.800273</td>
      <td>bdcb9758340444948f3af991c6b2478b</td>
      <td>Equity(34 [2886])</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2023-09-22 13:30:00+08:00</th>
      <td>46</td>
      <td>4904</td>
      <td>51900</td>
      <td>2023-09-22 13:30:00+08:00</td>
      <td>72.104506</td>
      <td>acc3c2d89f8e48c3bc42daa9e8d81560</td>
      <td>Equity(46 [4904])</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2023-09-25 13:30:00+08:00</th>
      <td>46</td>
      <td>4904</td>
      <td>-37450</td>
      <td>2023-09-25 13:30:00+08:00</td>
      <td>72.895444</td>
      <td>71a11f3296354834956e3a801721c806</td>
      <td>Equity(46 [4904])</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2023-09-25 13:30:00+08:00</th>
      <td>34</td>
      <td>2886</td>
      <td>-106951</td>
      <td>2023-09-25 13:30:00+08:00</td>
      <td>37.999742</td>
      <td>91e9060255b8480c88251ce5ed781b49</td>
      <td>Equity(34 [2886])</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2023-09-25 13:30:00+08:00</th>
      <td>24</td>
      <td>2603</td>
      <td>34894</td>
      <td>2023-09-25 13:30:00+08:00</td>
      <td>116.000161</td>
      <td>2777dbff1bbd48188466187cc31e69d3</td>
      <td>Equity(24 [2603])</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2023-09-25 13:30:00+08:00</th>
      <td>6</td>
      <td>1590</td>
      <td>4064</td>
      <td>2023-09-25 13:30:00+08:00</td>
      <td>981.008970</td>
      <td>1ec8dcf092f84220a87650c5db8959fc</td>
      <td>Equity(6 [1590])</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2023-09-26 13:30:00+08:00</th>
      <td>46</td>
      <td>4904</td>
      <td>-14450</td>
      <td>2023-09-26 13:30:00+08:00</td>
      <td>72.699787</td>
      <td>ceec5c24911044baba3d8c0abab96960</td>
      <td>Equity(46 [4904])</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2023-09-26 13:30:00+08:00</th>
      <td>24</td>
      <td>2603</td>
      <td>-34894</td>
      <td>2023-09-26 13:30:00+08:00</td>
      <td>115.499884</td>
      <td>dc7128121a9d40d182ec3d9d4d465492</td>
      <td>Equity(24 [2603])</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2023-09-26 13:30:00+08:00</th>
      <td>6</td>
      <td>1590</td>
      <td>-4062</td>
      <td>2023-09-26 13:30:00+08:00</td>
      <td>957.984660</td>
      <td>c55dc4e5611246698718518b5ad46860</td>
      <td>Equity(6 [1590])</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2023-09-26 13:30:00+08:00</th>
      <td>25</td>
      <td>2609</td>
      <td>87136</td>
      <td>2023-09-26 13:30:00+08:00</td>
      <td>45.950388</td>
      <td>5ca0608910f8443a9c2ec23de6c1ab6f</td>
      <td>Equity(25 [2609])</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2023-09-26 13:30:00+08:00</th>
      <td>34</td>
      <td>2886</td>
      <td>105366</td>
      <td>2023-09-26 13:30:00+08:00</td>
      <td>37.850331</td>
      <td>aafbcc931d8e4f87adb21686aeb0f227</td>
      <td>Equity(34 [2886])</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2023-09-27 13:30:00+08:00</th>
      <td>25</td>
      <td>2609</td>
      <td>-87136</td>
      <td>2023-09-27 13:30:00+08:00</td>
      <td>45.899835</td>
      <td>153b35815aa44224aebbd79d673403b2</td>
      <td>Equity(25 [2609])</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2023-09-27 13:30:00+08:00</th>
      <td>33</td>
      <td>2885</td>
      <td>157495</td>
      <td>2023-09-27 13:30:00+08:00</td>
      <td>25.150272</td>
      <td>b397a24cd315420683b711b7c933abc3</td>
      <td>Equity(33 [2885])</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2023-09-27 13:30:00+08:00</th>
      <td>34</td>
      <td>2886</td>
      <td>-1339</td>
      <td>2023-09-27 13:30:00+08:00</td>
      <td>37.700000</td>
      <td>2f3a95e39fd840dc8aca520f0c36f6b1</td>
      <td>Equity(34 [2886])</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2023-09-28 13:30:00+08:00</th>
      <td>33</td>
      <td>2885</td>
      <td>-157495</td>
      <td>2023-09-28 13:30:00+08:00</td>
      <td>25.049461</td>
      <td>1ebe571a863a415297cd8aa1bc2b07b9</td>
      <td>Equity(33 [2885])</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2023-09-28 13:30:00+08:00</th>
      <td>25</td>
      <td>2609</td>
      <td>85400</td>
      <td>2023-09-28 13:30:00+08:00</td>
      <td>45.450323</td>
      <td>432d560b9e99476d846b3675db5b2d44</td>
      <td>Equity(25 [2609])</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2023-09-28 13:30:00+08:00</th>
      <td>34</td>
      <td>2886</td>
      <td>-51</td>
      <td>2023-09-28 13:30:00+08:00</td>
      <td>37.700000</td>
      <td>9fb1d769ef504f44b2dd544653e997c2</td>
      <td>Equity(34 [2886])</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2023-10-02 13:30:00+08:00</th>
      <td>25</td>
      <td>2609</td>
      <td>-85400</td>
      <td>2023-10-02 13:30:00+08:00</td>
      <td>44.449880</td>
      <td>5a76b96aecf749d683699d19b7fc687c</td>
      <td>Equity(25 [2609])</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2023-10-02 13:30:00+08:00</th>
      <td>34</td>
      <td>2886</td>
      <td>-412</td>
      <td>2023-10-02 13:30:00+08:00</td>
      <td>37.600000</td>
      <td>c2f1f413dea8434f9ef69b9f58c40810</td>
      <td>Equity(34 [2886])</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2023-10-02 13:30:00+08:00</th>
      <td>6</td>
      <td>1590</td>
      <td>3988</td>
      <td>2023-10-02 13:30:00+08:00</td>
      <td>1005.008408</td>
      <td>c2c40f199a7f4f7a85e33a6f0fd9c3d7</td>
      <td>Equity(6 [1590])</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2023-10-03 13:30:00+08:00</th>
      <td>6</td>
      <td>1590</td>
      <td>-3988</td>
      <td>2023-10-03 13:30:00+08:00</td>
      <td>997.990178</td>
      <td>40c0549e04914d8db877272facf233f9</td>
      <td>Equity(6 [1590])</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2023-10-03 13:30:00+08:00</th>
      <td>24</td>
      <td>2603</td>
      <td>33982</td>
      <td>2023-10-03 13:30:00+08:00</td>
      <td>110.500048</td>
      <td>b990b03de87744508a9bfcbab7e14ba6</td>
      <td>Equity(24 [2603])</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2023-10-03 13:30:00+08:00</th>
      <td>34</td>
      <td>2886</td>
      <td>-985</td>
      <td>2023-10-03 13:30:00+08:00</td>
      <td>37.650000</td>
      <td>fcc61389fce5448297c04514a9523155</td>
      <td>Equity(34 [2886])</td>
      <td>None</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">positions</span><span class="p">[</span><span class="s1">&#39;mv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">positions</span><span class="p">[</span><span class="s1">&#39;last_sale_price&#39;</span><span class="p">]</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="n">positions</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sid</th>
      <th>symbol</th>
      <th>asset</th>
      <th>amount</th>
      <th>cost_basis</th>
      <th>last_sale_price</th>
      <th>mv</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-09-22 13:30:00+08:00</th>
      <td>34</td>
      <td>2886</td>
      <td>Equity(34 [2886])</td>
      <td>106951</td>
      <td>37.854139</td>
      <td>37.80</td>
      <td>4042747.80</td>
    </tr>
    <tr>
      <th>2023-09-22 13:30:00+08:00</th>
      <td>46</td>
      <td>4904</td>
      <td>Equity(46 [4904])</td>
      <td>51900</td>
      <td>72.207262</td>
      <td>72.10</td>
      <td>3741990.00</td>
    </tr>
    <tr>
      <th>2023-09-25 13:30:00+08:00</th>
      <td>46</td>
      <td>4904</td>
      <td>Equity(46 [4904])</td>
      <td>14450</td>
      <td>73.043317</td>
      <td>72.90</td>
      <td>1053405.00</td>
    </tr>
    <tr>
      <th>2023-09-25 13:30:00+08:00</th>
      <td>24</td>
      <td>2603</td>
      <td>Equity(24 [2603])</td>
      <td>34894</td>
      <td>116.165462</td>
      <td>116.00</td>
      <td>4047704.00</td>
    </tr>
    <tr>
      <th>2023-09-25 13:30:00+08:00</th>
      <td>6</td>
      <td>1590</td>
      <td>Equity(6 [1590])</td>
      <td>4064</td>
      <td>982.407100</td>
      <td>981.00</td>
      <td>3986784.00</td>
    </tr>
    <tr>
      <th>2023-09-26 13:30:00+08:00</th>
      <td>25</td>
      <td>2609</td>
      <td>Equity(25 [2609])</td>
      <td>87136</td>
      <td>46.015872</td>
      <td>45.95</td>
      <td>4003899.20</td>
    </tr>
    <tr>
      <th>2023-09-26 13:30:00+08:00</th>
      <td>34</td>
      <td>2886</td>
      <td>Equity(34 [2886])</td>
      <td>105366</td>
      <td>37.904276</td>
      <td>37.85</td>
      <td>3988103.10</td>
    </tr>
    <tr>
      <th>2023-09-27 13:30:00+08:00</th>
      <td>34</td>
      <td>2886</td>
      <td>Equity(34 [2886])</td>
      <td>104027</td>
      <td>37.906429</td>
      <td>37.70</td>
      <td>3921817.90</td>
    </tr>
    <tr>
      <th>2023-09-27 13:30:00+08:00</th>
      <td>33</td>
      <td>2885</td>
      <td>Equity(33 [2885])</td>
      <td>157495</td>
      <td>25.186114</td>
      <td>25.15</td>
      <td>3960999.25</td>
    </tr>
    <tr>
      <th>2023-09-28 13:30:00+08:00</th>
      <td>34</td>
      <td>2886</td>
      <td>Equity(34 [2886])</td>
      <td>103976</td>
      <td>37.906679</td>
      <td>37.70</td>
      <td>3919895.20</td>
    </tr>
    <tr>
      <th>2023-09-28 13:30:00+08:00</th>
      <td>25</td>
      <td>2609</td>
      <td>Equity(25 [2609])</td>
      <td>85400</td>
      <td>45.515101</td>
      <td>45.45</td>
      <td>3881430.00</td>
    </tr>
    <tr>
      <th>2023-10-02 13:30:00+08:00</th>
      <td>34</td>
      <td>2886</td>
      <td>Equity(34 [2886])</td>
      <td>103564</td>
      <td>37.907355</td>
      <td>37.60</td>
      <td>3894006.40</td>
    </tr>
    <tr>
      <th>2023-10-02 13:30:00+08:00</th>
      <td>6</td>
      <td>1590</td>
      <td>Equity(6 [1590])</td>
      <td>3988</td>
      <td>1006.440705</td>
      <td>1005.00</td>
      <td>4007940.00</td>
    </tr>
    <tr>
      <th>2023-10-03 13:30:00+08:00</th>
      <td>34</td>
      <td>2886</td>
      <td>Equity(34 [2886])</td>
      <td>102579</td>
      <td>37.908964</td>
      <td>37.65</td>
      <td>3862099.35</td>
    </tr>
    <tr>
      <th>2023-10-03 13:30:00+08:00</th>
      <td>24</td>
      <td>2603</td>
      <td>Equity(24 [2603])</td>
      <td>33982</td>
      <td>110.657513</td>
      <td>110.50</td>
      <td>3755011.00</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="n">stats</span><span class="o">.</span><span class="n">net_leverage</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>2023-09-21 13:30:00+08:00    0.000000
2023-09-22 13:30:00+08:00    0.779359
2023-09-25 13:30:00+08:00    0.907900
2023-09-26 13:30:00+08:00    0.811908
2023-09-27 13:30:00+08:00    0.804394
2023-09-28 13:30:00+08:00    0.799249
2023-10-02 13:30:00+08:00    0.819500
2023-10-03 13:30:00+08:00    0.793739
Name: net_leverage, dtype: float64
</code></pre></div>
<p><span id="Case2"></span></p>
<h2 id="case-2-max_leverage">Case 2 調整max_leverage</h2>
<p><a href="#menu">Return to Menu</a></p>
<p>接續<strong>Case 1</strong>，多調整<code>max_leverage=0.70</code>，其餘與<strong>Case 1</strong>相同。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="n">algo</span> <span class="o">=</span> <span class="n">TargetPercentPipeAlgo</span><span class="p">(</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>                     <span class="n">start_session</span><span class="o">=</span><span class="n">algo_start_dt</span><span class="p">,</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>                     <span class="n">end_session</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>                     <span class="n">max_leverage</span><span class="o">=</span><span class="mf">0.70</span><span class="p">,</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>                     <span class="n">pipeline</span><span class="o">=</span><span class="n">make_pipeline</span><span class="p">,</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="p">)</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="c1"># set_algo_instance</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="n">set_algo_instance</span><span class="p">(</span><span class="n">algo</span><span class="p">)</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="c1"># run</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="n">stats</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>[2024-03-13 02:41:05.749665]: INFO: rebalance: Cancel_order: current time: 2023-09-25 , created: 2023-09-25 , asset: Equity(46 [4904]), amount: -11093 , filled: 0
[2024-03-13 02:41:05.753066]: INFO: earn_dividends: Equity(6 [1590]), cash_dividend amount: 13.43905496, pay_date: 2023-10-30, div_owed: 47789.27943776
[2024-03-13 02:41:05.754062]: INFO: handle_split: after split: asset: Equity(6 [1590]), amount: 3554, cost_basis: 982.73, last_sale_price: 981.0
[2024-03-13 02:41:05.754062]: INFO: handle_split: returning cash: 809.13
[2024-03-13 02:41:05.795164]: INFO: handle_simulation_end: Simulated 8 trading days
first open: 2023-09-21 01:01:00+00:00
last close: 2023-10-03 05:30:00+00:00
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">stats</span><span class="o">.</span><span class="n">net_leverage</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>2023-09-21 13:30:00+08:00    0.000000
2023-09-22 13:30:00+08:00    0.704456
2023-09-25 13:30:00+08:00    0.783204
2023-09-26 13:30:00+08:00    0.708862
2023-09-27 13:30:00+08:00    0.703443
2023-09-28 13:30:00+08:00    0.698989
2023-10-02 13:30:00+08:00    0.715883
2023-10-03 13:30:00+08:00    0.694088
Name: net_leverage, dtype: float64
</code></pre></div>
<p><span id="Case3"></span></p>
<h2 id="case-3-tradeday">Case 3 調整tradeday</h2>
<p><a href="#menu">Return to Menu</a>  </p>
<p>接續<strong>Case 1</strong>，多新增<code>tradeday</code>，其餘與<strong>Case 1</strong>相同。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1"># 設定再平衡日期</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="n">freq</span> <span class="o">=</span> <span class="s1">&#39;MS&#39;</span>   <span class="c1"># QS-JUL  MS W</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="n">_tradeday</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_dt</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">))</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="n">tradeday</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_calendar</span><span class="p">(</span><span class="n">calendar_name</span><span class="p">)</span><span class="o">.</span><span class="n">next_open</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> \
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>           <span class="n">get_calendar</span><span class="p">(</span><span class="n">calendar_name</span><span class="p">)</span><span class="o">.</span><span class="n">is_session</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span> <span class="k">else</span> <span class="n">i</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_tradeday</span><span class="p">]</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="n">tradeday</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>[&#39;2023-06-01&#39;, &#39;2023-07-03&#39;, &#39;2023-08-01&#39;, &#39;2023-09-01&#39;, &#39;2023-10-02&#39;]
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="n">algo_start_dt</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Timestamp(&#39;2023-09-21 00:00:00+0000&#39;, tz=&#39;UTC&#39;)
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="n">algo</span> <span class="o">=</span> <span class="n">TargetPercentPipeAlgo</span><span class="p">(</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>                     <span class="n">start_session</span><span class="o">=</span><span class="n">algo_start_dt</span><span class="p">,</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>                     <span class="n">end_session</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span>           
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>                     <span class="n">tradeday</span><span class="o">=</span><span class="n">tradeday</span><span class="p">,</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>                     <span class="n">pipeline</span><span class="o">=</span><span class="n">make_pipeline</span><span class="p">,</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="p">)</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="c1"># set_algo_instance</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="n">set_algo_instance</span><span class="p">(</span><span class="n">algo</span><span class="p">)</span>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="c1"># run</span>
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a><span class="n">stats</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>[2024-03-13 02:41:05.883443]: INFO: handle_simulation_end: Simulated 8 trading days
first open: 2023-09-21 01:01:00+00:00
last close: 2023-10-03 05:30:00+00:00
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="n">positions</span><span class="p">,</span> <span class="n">transactions</span><span class="p">,</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">get_transaction_detail</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="n">transactions</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sid</th>
      <th>symbol</th>
      <th>amount</th>
      <th>dt</th>
      <th>price</th>
      <th>order_id</th>
      <th>asset</th>
      <th>commission</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-10-03 13:30:00+08:00</th>
      <td>24</td>
      <td>2603</td>
      <td>35242</td>
      <td>2023-10-03 13:30:00+08:00</td>
      <td>110.500051</td>
      <td>35a33e935bde4439b8e113256e10f083</td>
      <td>Equity(24 [2603])</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2023-10-03 13:30:00+08:00</th>
      <td>34</td>
      <td>2886</td>
      <td>106382</td>
      <td>2023-10-03 13:30:00+08:00</td>
      <td>37.650179</td>
      <td>fb0b44482bc54fff9b6dec3fd649e715</td>
      <td>Equity(34 [2886])</td>
      <td>None</td>
    </tr>
  </tbody>
</table>
</div>

<p><span id="Case4"></span></p>
<h2 id="case-4-rebalance_date_rule">Case 4 調整rebalance_date_rule</h2>
<p><a href="#menu">Return to Menu</a>  </p>
<p>接續<strong>Case 1</strong>，多新增<code>rebalance_date_rule</code>，並修改<code>start_session</code>為2023-09-01，其餘與<strong>Case 1</strong>相同。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="kn">from</span> <span class="nn">zipline.api</span> <span class="kn">import</span> <span class="n">date_rules</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="n">algo</span> <span class="o">=</span> <span class="n">TargetPercentPipeAlgo</span><span class="p">(</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>                     <span class="n">start_session</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2023-09-01&#39;</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s1">&#39;UTC&#39;</span><span class="p">),</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>                     <span class="n">end_session</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>                     <span class="n">pipeline</span><span class="o">=</span><span class="n">make_pipeline</span><span class="p">,</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>                     <span class="c1"># 每月的第四個交易日下單</span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>                     <span class="n">rebalance_date_rule</span><span class="o">=</span><span class="n">date_rules</span><span class="o">.</span><span class="n">month_start</span><span class="p">(</span><span class="n">days_offset</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> 
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="p">)</span>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="c1"># set_algo_instance</span>
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="n">set_algo_instance</span><span class="p">(</span><span class="n">algo</span><span class="p">)</span>
<a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a>
<a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a><span class="c1"># run</span>
<a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a><span class="n">stats</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>[2024-03-13 02:41:06.016104]: INFO: handle_simulation_end: Simulated 22 trading days
first open: 2023-09-01 01:01:00+00:00
last close: 2023-10-03 05:30:00+00:00
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="n">positions</span><span class="p">,</span> <span class="n">transactions</span><span class="p">,</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">get_transaction_detail</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="n">orders</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sid</th>
      <th>symbol</th>
      <th>id</th>
      <th>dt</th>
      <th>reason</th>
      <th>created</th>
      <th>amount</th>
      <th>filled</th>
      <th>commission</th>
      <th>stop</th>
      <th>limit</th>
      <th>stop_reached</th>
      <th>limit_reached</th>
      <th>asset</th>
      <th>status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-09-06 13:30:00+08:00</th>
      <td>41</td>
      <td>3034</td>
      <td>4706e48bb8644098b53fd9a9c90ed314</td>
      <td>2023-09-06 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-09-06 13:30:00+08:00</td>
      <td>9411</td>
      <td>0</td>
      <td>0</td>
      <td>None</td>
      <td>None</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(41 [3034])</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2023-09-06 13:30:00+08:00</th>
      <td>14</td>
      <td>2327</td>
      <td>ca20e3e3e6554702a701388075f7b1f3</td>
      <td>2023-09-06 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-09-06 13:30:00+08:00</td>
      <td>7920</td>
      <td>0</td>
      <td>0</td>
      <td>None</td>
      <td>None</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(14 [2327])</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2023-09-07 13:30:00+08:00</th>
      <td>41</td>
      <td>3034</td>
      <td>4706e48bb8644098b53fd9a9c90ed314</td>
      <td>2023-09-07 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-09-06 13:30:00+08:00</td>
      <td>9411</td>
      <td>9411</td>
      <td>5727</td>
      <td>None</td>
      <td>None</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(41 [3034])</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2023-09-07 13:30:00+08:00</th>
      <td>14</td>
      <td>2327</td>
      <td>ca20e3e3e6554702a701388075f7b1f3</td>
      <td>2023-09-07 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-09-06 13:30:00+08:00</td>
      <td>7920</td>
      <td>7920</td>
      <td>5666</td>
      <td>None</td>
      <td>None</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(14 [2327])</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>

<p><span id="Case5"></span></p>
<h2 id="case-5-slippage_model">Case 5 調整slippage_model</h2>
<p><a href="#menu">Return to Menu</a>  </p>
<p>接續<strong>Case 1</strong>，多新增<code>slippage_model</code>，將<code>volume_limit</code>由<strong>0.025</strong>調整為<strong>0.01</strong>，其餘與<strong>Case 1</strong>相同。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="n">algo</span> <span class="o">=</span> <span class="n">TargetPercentPipeAlgo</span><span class="p">(</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>                     <span class="n">start_session</span><span class="o">=</span><span class="n">algo_start_dt</span><span class="p">,</span>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>                     <span class="n">end_session</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>                     <span class="n">pipeline</span><span class="o">=</span><span class="n">make_pipeline</span><span class="p">,</span>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>                     <span class="n">slippage_model</span><span class="o">=</span><span class="n">slippage</span><span class="o">.</span><span class="n">VolumeShareSlippage</span><span class="p">(</span><span class="n">volume_limit</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">price_impact</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="p">)</span>
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a>
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="c1"># set_algo_instance</span>
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="n">set_algo_instance</span><span class="p">(</span><span class="n">algo</span><span class="p">)</span>
<a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a>
<a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="c1"># run</span>
<a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="n">stats</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>[2024-03-13 02:41:06.113628]: INFO: rebalance: Cancel_order: current time: 2023-09-22 , created: 2023-09-21 , asset: Equity(46 [4904]), amount: 55478 , filled: 20760
[2024-03-13 02:41:06.121367]: INFO: rebalance: Cancel_order: current time: 2023-09-25 , created: 2023-09-25 , asset: Equity(46 [4904]), amount: -5780 , filled: 0
[2024-03-13 02:41:06.121367]: INFO: earn_dividends: Equity(6 [1590]), cash_dividend amount: 13.43905496, pay_date: 2023-10-30, div_owed: 54629.7584124
[2024-03-13 02:41:06.121367]: INFO: handle_split: after split: asset: Equity(6 [1590]), amount: 4063, cost_basis: 982.73, last_sale_price: 981.0
[2024-03-13 02:41:06.121367]: INFO: handle_split: returning cash: 643.62
[2024-03-13 02:41:06.132990]: INFO: rebalance: Cancel_order: current time: 2023-09-26 , created: 2023-09-26 , asset: Equity(6 [1590]), amount: -853 , filled: 0
[2024-03-13 02:41:06.138066]: INFO: rebalance: Cancel_order: current time: 2023-09-27 , created: 2023-09-26 , asset: Equity(33 [2885]), amount: 157400 , filled: 151500
[2024-03-13 02:41:06.138066]: INFO: rebalance: Cancel_order: current time: 2023-09-28 , created: 2023-09-28 , asset: Equity(33 [2885]), amount: -44120 , filled: 0
[2024-03-13 02:41:06.171376]: INFO: handle_simulation_end: Simulated 8 trading days
first open: 2023-09-21 01:01:00+00:00
last close: 2023-10-03 05:30:00+00:00
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="n">positions</span><span class="p">,</span> <span class="n">transactions</span><span class="p">,</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">get_transaction_detail</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="n">orders</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(symbol == &quot;1590&quot;) &amp; (created.dt.strftime(&quot;%Y-%m-</span><span class="si">%d</span><span class="s1">&quot;) == &quot;2023-09-25&quot;)&#39;</span><span class="p">)</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sid</th>
      <th>symbol</th>
      <th>id</th>
      <th>dt</th>
      <th>reason</th>
      <th>created</th>
      <th>amount</th>
      <th>filled</th>
      <th>commission</th>
      <th>stop</th>
      <th>limit</th>
      <th>stop_reached</th>
      <th>limit_reached</th>
      <th>asset</th>
      <th>status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-09-25 13:30:00+08:00</th>
      <td>6</td>
      <td>1590</td>
      <td>3217f240f39a4bc88fcdce896268d7cc</td>
      <td>2023-09-25 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-09-25 13:30:00+08:00</td>
      <td>-4065</td>
      <td>0</td>
      <td>0.0</td>
      <td>None</td>
      <td>None</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(6 [1590])</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2023-09-26 13:30:00+08:00</th>
      <td>6</td>
      <td>1590</td>
      <td>3217f240f39a4bc88fcdce896268d7cc</td>
      <td>2023-09-26 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-09-25 13:30:00+08:00</td>
      <td>-4063</td>
      <td>-3210</td>
      <td>13609.0</td>
      <td>None</td>
      <td>None</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(6 [1590])</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="c1"># 321000 * 1% = 3210(股) </span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="n">df_bundle_price</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(symbol == &quot;1590&quot;) &amp; (date.dt.strftime(&quot;%Y-%m-</span><span class="si">%d</span><span class="s1">&quot;) == &quot;2023-09-26&quot;)&#39;</span><span class="p">)[[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;volume&#39;</span><span class="p">]]</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>symbol</th>
      <th>date</th>
      <th>volume</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>4486</th>
      <td>1590</td>
      <td>2023-09-26 00:00:00+00:00</td>
      <td>321000.0</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="n">orders</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(symbol == &quot;2885&quot;) &amp; (created.dt.strftime(&quot;%Y-%m-</span><span class="si">%d</span><span class="s1">&quot;) == &quot;2023-09-27&quot;)&#39;</span><span class="p">)</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sid</th>
      <th>symbol</th>
      <th>id</th>
      <th>dt</th>
      <th>reason</th>
      <th>created</th>
      <th>amount</th>
      <th>filled</th>
      <th>commission</th>
      <th>stop</th>
      <th>limit</th>
      <th>stop_reached</th>
      <th>limit_reached</th>
      <th>asset</th>
      <th>status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-09-27 13:30:00+08:00</th>
      <td>33</td>
      <td>2885</td>
      <td>06063291dd4e449a8871819852919f94</td>
      <td>2023-09-27 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-09-27 13:30:00+08:00</td>
      <td>-151500</td>
      <td>0</td>
      <td>0.0</td>
      <td>None</td>
      <td>None</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(33 [2885])</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2023-09-28 13:30:00+08:00</th>
      <td>33</td>
      <td>2885</td>
      <td>06063291dd4e449a8871819852919f94</td>
      <td>2023-09-28 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-09-27 13:30:00+08:00</td>
      <td>-151500</td>
      <td>-107380</td>
      <td>11904.0</td>
      <td>None</td>
      <td>None</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(33 [2885])</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="c1"># 10738000 * 1% = 107380(股) </span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="n">df_bundle_price</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(symbol == &quot;2885&quot;) &amp; (date.dt.strftime(&quot;%Y-%m-</span><span class="si">%d</span><span class="s1">&quot;) == &quot;2023-09-28&quot;)&#39;</span><span class="p">)[[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;volume&#39;</span><span class="p">]]</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>symbol</th>
      <th>date</th>
      <th>volume</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>4625</th>
      <td>2885</td>
      <td>2023-09-28 00:00:00+00:00</td>
      <td>10738000.0</td>
    </tr>
  </tbody>
</table>
</div>

<p><span id="Case6"></span></p>
<h2 id="case-6-stocklist">Case 6 調整stocklist</h2>
<p><a href="#menu">Return to Menu</a>  </p>
<p>接續<strong>Case 1</strong>，多新增<code>stocklist</code>，其餘與<strong>Case 1</strong>相同。  </p>
<p>註1：<code>stocklist</code>限制是在pipeline執行完後。  </p>
<p>註2：也可以使用pipeline直接限制股票池。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="nb">len</span><span class="p">(</span><span class="n">StockList</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>55
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="n">_StockList</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">StockList</span> <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="s1">&#39;2886&#39;</span><span class="p">]</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="nb">len</span><span class="p">(</span><span class="n">_StockList</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>54
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="n">algo</span> <span class="o">=</span> <span class="n">TargetPercentPipeAlgo</span><span class="p">(</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>                     <span class="n">start_session</span><span class="o">=</span><span class="n">algo_start_dt</span><span class="p">,</span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>                     <span class="n">end_session</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span>            
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>                     <span class="n">stocklist</span><span class="o">=</span><span class="n">_StockList</span><span class="p">,</span>
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a>                     <span class="n">pipeline</span><span class="o">=</span><span class="n">make_pipeline</span><span class="p">,</span>
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="p">)</span>
<a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a>
<a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="c1"># set_algo_instance</span>
<a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a><span class="n">set_algo_instance</span><span class="p">(</span><span class="n">algo</span><span class="p">)</span>
<a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a>
<a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a><span class="c1"># run</span>
<a id="__codelineno-39-12" name="__codelineno-39-12" href="#__codelineno-39-12"></a><span class="n">stats</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>[2024-03-13 02:41:06.339500]: INFO: rebalance: Cancel_order: current time: 2023-09-22 , created: 2023-09-21 , asset: Equity(46 [4904]), amount: 55478 , filled: 51900
[2024-03-13 02:41:06.346237]: INFO: rebalance: Cancel_order: current time: 2023-09-25 , created: 2023-09-25 , asset: Equity(46 [4904]), amount: -14450 , filled: 0
[2024-03-13 02:41:06.349619]: INFO: earn_dividends: Equity(6 [1590]), cash_dividend amount: 13.43905496, pay_date: 2023-10-30, div_owed: 54643.19746736
[2024-03-13 02:41:06.350619]: INFO: handle_split: after split: asset: Equity(6 [1590]), amount: 4064, cost_basis: 982.73, last_sale_price: 981.0
[2024-03-13 02:41:06.350619]: INFO: handle_split: returning cash: 643.29
[2024-03-13 02:41:06.385375]: INFO: handle_simulation_end: Simulated 8 trading days
first open: 2023-09-21 01:01:00+00:00
last close: 2023-10-03 05:30:00+00:00
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="n">positions</span><span class="p">,</span> <span class="n">transactions</span><span class="p">,</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">get_transaction_detail</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="n">positions</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sid</th>
      <th>symbol</th>
      <th>asset</th>
      <th>amount</th>
      <th>cost_basis</th>
      <th>last_sale_price</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-09-22 13:30:00+08:00</th>
      <td>46</td>
      <td>4904</td>
      <td>Equity(46 [4904])</td>
      <td>51900</td>
      <td>72.207262</td>
      <td>72.10</td>
    </tr>
    <tr>
      <th>2023-09-25 13:30:00+08:00</th>
      <td>46</td>
      <td>4904</td>
      <td>Equity(46 [4904])</td>
      <td>14450</td>
      <td>73.043317</td>
      <td>72.90</td>
    </tr>
    <tr>
      <th>2023-09-25 13:30:00+08:00</th>
      <td>24</td>
      <td>2603</td>
      <td>Equity(24 [2603])</td>
      <td>34915</td>
      <td>116.165477</td>
      <td>116.00</td>
    </tr>
    <tr>
      <th>2023-09-25 13:30:00+08:00</th>
      <td>6</td>
      <td>1590</td>
      <td>Equity(6 [1590])</td>
      <td>4066</td>
      <td>982.407159</td>
      <td>981.00</td>
    </tr>
    <tr>
      <th>2023-09-26 13:30:00+08:00</th>
      <td>25</td>
      <td>2609</td>
      <td>Equity(25 [2609])</td>
      <td>87157</td>
      <td>46.015867</td>
      <td>45.95</td>
    </tr>
    <tr>
      <th>2023-09-27 13:30:00+08:00</th>
      <td>33</td>
      <td>2885</td>
      <td>Equity(33 [2885])</td>
      <td>157624</td>
      <td>25.186117</td>
      <td>25.15</td>
    </tr>
    <tr>
      <th>2023-09-28 13:30:00+08:00</th>
      <td>25</td>
      <td>2609</td>
      <td>Equity(25 [2609])</td>
      <td>85610</td>
      <td>45.515095</td>
      <td>45.45</td>
    </tr>
    <tr>
      <th>2023-10-02 13:30:00+08:00</th>
      <td>6</td>
      <td>1590</td>
      <td>Equity(6 [1590])</td>
      <td>3997</td>
      <td>1006.440770</td>
      <td>1005.00</td>
    </tr>
    <tr>
      <th>2023-10-03 13:30:00+08:00</th>
      <td>24</td>
      <td>2603</td>
      <td>Equity(24 [2603])</td>
      <td>34102</td>
      <td>110.657517</td>
      <td>110.50</td>
    </tr>
  </tbody>
</table>
</div>

<p><span id="Case7"></span></p>
<h2 id="case-7-order_filling_policy">Case 7 調整order_filling_policy</h2>
<p><a href="#menu">Return to Menu</a> </p>
<p>接續<strong>Case 1</strong>，多新增<code>order_filling_policy='current_bar'</code>，其餘與<strong>Case 1</strong>相同。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="n">algo</span> <span class="o">=</span> <span class="n">TargetPercentPipeAlgo</span><span class="p">(</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>                     <span class="n">start_session</span><span class="o">=</span><span class="n">algo_start_dt</span><span class="p">,</span>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>                     <span class="n">end_session</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>                     <span class="n">pipeline</span><span class="o">=</span><span class="n">make_pipeline</span><span class="p">,</span>
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>                     <span class="n">order_filling_policy</span><span class="o">=</span><span class="s1">&#39;current_bar&#39;</span>
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="p">)</span>
<a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a>
<a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a><span class="c1"># set_algo_instance</span>
<a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a><span class="n">set_algo_instance</span><span class="p">(</span><span class="n">algo</span><span class="p">)</span>
<a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a>
<a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a><span class="c1"># run</span>
<a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a><span class="n">stats</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>[2024-03-13 02:41:06.476428]: INFO: rebalance: Cancel_order: current time: 2023-09-25 , created: 2023-09-25 , asset: Equity(46 [4904]), amount: -3578 , filled: 0
[2024-03-13 02:41:06.523514]: INFO: handle_simulation_end: Simulated 8 trading days
first open: 2023-09-21 01:01:00+00:00
last close: 2023-10-03 05:30:00+00:00
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="n">positions</span><span class="p">,</span> <span class="n">transactions</span><span class="p">,</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">get_transaction_detail</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2023-09-22&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;longs == True&#39;</span><span class="p">)</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>longs</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Equity(6 [1590])</th>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(24 [2603])</th>
      <td>True</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="c1"># 從`orders`中可以發現created=2023-09-22的單在當天就成交（status由0變為1）</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="n">orders</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2023-09-22&#39;</span><span class="p">]</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sid</th>
      <th>symbol</th>
      <th>id</th>
      <th>dt</th>
      <th>reason</th>
      <th>created</th>
      <th>amount</th>
      <th>filled</th>
      <th>commission</th>
      <th>stop</th>
      <th>limit</th>
      <th>stop_reached</th>
      <th>limit_reached</th>
      <th>asset</th>
      <th>status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-09-22 13:30:00+08:00</th>
      <td>34</td>
      <td>2886</td>
      <td>36e7f2eb3d37492e829558f5748560aa</td>
      <td>2023-09-22 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-09-22 08:45:00+08:00</td>
      <td>-106951</td>
      <td>-106951</td>
      <td>17890.0</td>
      <td>None</td>
      <td>None</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(34 [2886])</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2023-09-22 13:30:00+08:00</th>
      <td>46</td>
      <td>4904</td>
      <td>0fc833a0c418408dae3da988454b2029</td>
      <td>2023-09-22 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-09-22 08:45:00+08:00</td>
      <td>-55478</td>
      <td>-51900</td>
      <td>16559.0</td>
      <td>None</td>
      <td>None</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(46 [4904])</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2023-09-22 13:30:00+08:00</th>
      <td>24</td>
      <td>2603</td>
      <td>737aa5d17c9c43ff814b7c09a94898fe</td>
      <td>2023-09-22 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-09-22 08:45:00+08:00</td>
      <td>35043</td>
      <td>35043</td>
      <td>5718.0</td>
      <td>None</td>
      <td>None</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(24 [2603])</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2023-09-22 13:30:00+08:00</th>
      <td>6</td>
      <td>1590</td>
      <td>50897cf4326c46abbea7efdf8869a5af</td>
      <td>2023-09-22 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-09-22 08:45:00+08:00</td>
      <td>4081</td>
      <td>4081</td>
      <td>5717.0</td>
      <td>None</td>
      <td>None</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(6 [1590])</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>

<p><span id="Case8"></span></p>
<h2 id="case-8-allow_short">Case 8 調整allow_short</h2>
<p><a href="#menu">Return to Menu</a> </p>
<p>接續<strong>Case 1</strong>，多新增<code>allow_short=True</code>，其餘與<strong>Case 1</strong>相同。  </p>
<p>以下設定pipeline（<code>make_pipeline()</code>），並定義<code>shorts</code>欄位用來判斷須放空的股票。在<code>shorts</code>欄位中要放空的股票標記為True，反之標記為False。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="k">def</span> <span class="nf">make_pipeline</span><span class="p">():</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>    <span class="n">rsi</span> <span class="o">=</span> <span class="n">RSI</span><span class="p">()</span>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>    <span class="n">longs</span> <span class="o">=</span> <span class="n">rsi</span><span class="o">.</span><span class="n">top</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">SingleAsset</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">asset_finder</span><span class="o">.</span><span class="n">lookup_symbol</span><span class="p">(</span><span class="s1">&#39;IR0001&#39;</span><span class="p">,</span> <span class="n">as_of_date</span><span class="o">=</span><span class="kc">None</span><span class="p">)))</span>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>    <span class="n">shorts</span> <span class="o">=</span> <span class="n">rsi</span><span class="o">.</span><span class="n">bottom</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">SingleAsset</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">asset_finder</span><span class="o">.</span><span class="n">lookup_symbol</span><span class="p">(</span><span class="s1">&#39;IR0001&#39;</span><span class="p">,</span> <span class="n">as_of_date</span><span class="o">=</span><span class="kc">None</span><span class="p">)))</span>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a>
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a>    <span class="k">return</span> <span class="n">Pipeline</span><span class="p">(</span>
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a>        <span class="n">columns</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a>            <span class="s2">&quot;longs&quot;</span> <span class="p">:</span> <span class="n">longs</span><span class="p">,</span>
<a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a>            <span class="s2">&quot;shorts&quot;</span> <span class="p">:</span> <span class="n">shorts</span>
<a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a>        <span class="p">}</span>
<a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a>    <span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="n">result</span> <span class="o">=</span> <span class="n">run_pipeline</span><span class="p">(</span><span class="n">make_pipeline</span><span class="p">(),</span> <span class="n">algo_start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="n">result</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(longs == True) | (shorts == True)&#39;</span> <span class="p">)</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>longs</th>
      <th>shorts</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="4" valign="top">2023-09-22 00:00:00+00:00</th>
      <th>Equity(6 [1590])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(10 [2301])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(24 [2603])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(39 [2912])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">2023-09-25 00:00:00+00:00</th>
      <th>Equity(10 [2301])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(25 [2609])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(31 [2883])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(34 [2886])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">2023-09-26 00:00:00+00:00</th>
      <th>Equity(8 [2002])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(10 [2301])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(33 [2885])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(34 [2886])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">2023-09-27 00:00:00+00:00</th>
      <th>Equity(10 [2301])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(17 [2357])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(25 [2609])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(34 [2886])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">2023-09-28 00:00:00+00:00</th>
      <th>Equity(6 [1590])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(10 [2301])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(34 [2886])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(39 [2912])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">2023-10-02 00:00:00+00:00</th>
      <th>Equity(10 [2301])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(24 [2603])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(34 [2886])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(39 [2912])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">2023-10-03 00:00:00+00:00</th>
      <th>Equity(2 [1301])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(6 [1590])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(14 [2327])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(30 [2882])</th>
      <td>False</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="n">algo</span> <span class="o">=</span> <span class="n">TargetPercentPipeAlgo</span><span class="p">(</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a>                     <span class="n">start_session</span><span class="o">=</span><span class="n">algo_start_dt</span><span class="p">,</span>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a>                     <span class="n">end_session</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span>
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a>                     <span class="n">allow_short</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a>                     <span class="n">pipeline</span><span class="o">=</span><span class="n">make_pipeline</span><span class="p">,</span>
<a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a><span class="p">)</span>
<a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a>
<a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a><span class="c1"># set_algo_instance</span>
<a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a><span class="n">set_algo_instance</span><span class="p">(</span><span class="n">algo</span><span class="p">)</span>
<a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a>
<a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a><span class="c1"># run</span>
<a id="__codelineno-48-12" name="__codelineno-48-12" href="#__codelineno-48-12"></a><span class="n">stats</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>[2024-03-13 02:41:06.669320]: INFO: rebalance: Cancel_order: current time: 2023-09-22 , created: 2023-09-21 , asset: Equity(46 [4904]), amount: 55478 , filled: 51900
[2024-03-13 02:41:06.681121]: INFO: rebalance: Cancel_order: current time: 2023-09-25 , created: 2023-09-25 , asset: Equity(46 [4904]), amount: -14450 , filled: 0
[2024-03-13 02:41:06.687058]: INFO: earn_dividends: Equity(6 [1590]), cash_dividend amount: 13.43905496, pay_date: 2023-10-30, div_owed: 54414.73353304
[2024-03-13 02:41:06.687453]: INFO: handle_split: after split: asset: Equity(6 [1590]), amount: 4047, cost_basis: 982.73, last_sale_price: 981.0
[2024-03-13 02:41:06.687453]: INFO: handle_split: returning cash: 648.82
[2024-03-13 02:41:06.734225]: INFO: rebalance: Cancel_order: current time: 2023-10-02 , created: 2023-09-28 , asset: Equity(39 [2912]), amount: -14669 , filled: -8575
[2024-03-13 02:41:06.747551]: INFO: handle_simulation_end: Simulated 8 trading days
first open: 2023-09-21 01:01:00+00:00
last close: 2023-10-03 05:30:00+00:00
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="n">positions</span><span class="p">,</span> <span class="n">transactions</span><span class="p">,</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">get_transaction_detail</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="c1"># 當天取消</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="n">orders</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(symbol == &quot;2912&quot;) &amp; (created.dt.strftime(&quot;%Y-%m-</span><span class="si">%d</span><span class="s1">&quot;) == &quot;2023-09-28&quot;)&#39;</span><span class="p">)</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sid</th>
      <th>symbol</th>
      <th>id</th>
      <th>dt</th>
      <th>reason</th>
      <th>created</th>
      <th>amount</th>
      <th>filled</th>
      <th>commission</th>
      <th>stop</th>
      <th>limit</th>
      <th>stop_reached</th>
      <th>limit_reached</th>
      <th>asset</th>
      <th>status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-09-28 13:30:00+08:00</th>
      <td>39</td>
      <td>2912</td>
      <td>2ed71c04d41546fabc89536cab7b49de</td>
      <td>2023-09-28 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-09-28 13:30:00+08:00</td>
      <td>-14669</td>
      <td>0</td>
      <td>0.0</td>
      <td>None</td>
      <td>None</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(39 [2912])</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2023-10-02 13:30:00+08:00</th>
      <td>39</td>
      <td>2912</td>
      <td>2ed71c04d41546fabc89536cab7b49de</td>
      <td>2023-10-02 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-09-28 13:30:00+08:00</td>
      <td>-14669</td>
      <td>-8575</td>
      <td>9980.0</td>
      <td>None</td>
      <td>None</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(39 [2912])</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="c1"># 343000 * 2.5% = 8575(股) </span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="n">df_bundle_price</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(symbol == &quot;2912&quot;) &amp; (date.dt.strftime(&quot;%Y-%m-</span><span class="si">%d</span><span class="s1">&quot;) == &quot;2023-10-02&quot;)&#39;</span><span class="p">)[[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;volume&#39;</span><span class="p">]]</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>symbol</th>
      <th>date</th>
      <th>volume</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>4687</th>
      <td>2912</td>
      <td>2023-10-02 00:00:00+00:00</td>
      <td>343000.0</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="n">positions</span><span class="p">[</span><span class="s1">&#39;mv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">positions</span><span class="p">[</span><span class="s1">&#39;last_sale_price&#39;</span><span class="p">]</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="n">positions</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(symbol == &quot;2912&quot;)&#39;</span><span class="p">)</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sid</th>
      <th>symbol</th>
      <th>asset</th>
      <th>amount</th>
      <th>cost_basis</th>
      <th>last_sale_price</th>
      <th>mv</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-09-25 13:30:00+08:00</th>
      <td>39</td>
      <td>2912</td>
      <td>Equity(39 [2912])</td>
      <td>-15079</td>
      <td>263.315631</td>
      <td>264.5</td>
      <td>-3988395.5</td>
    </tr>
    <tr>
      <th>2023-10-02 13:30:00+08:00</th>
      <td>39</td>
      <td>2912</td>
      <td>Equity(39 [2912])</td>
      <td>-8575</td>
      <td>261.819714</td>
      <td>263.0</td>
      <td>-2255225.0</td>
    </tr>
    <tr>
      <th>2023-10-03 13:30:00+08:00</th>
      <td>39</td>
      <td>2912</td>
      <td>Equity(39 [2912])</td>
      <td>-14152</td>
      <td>261.433302</td>
      <td>262.0</td>
      <td>-3707824.0</td>
    </tr>
  </tbody>
</table>
</div>

<p><span id="Case9"></span></p>
<h2 id="case-9-cancel_datedelta">Case 9 調整cancel_datedelta</h2>
<p><a href="#menu">Return to Menu</a> </p>
<p>接續<strong>Case 8</strong>，多新增<code>cancel_datedelta=2</code>，其餘與<strong>Case 8</strong>相同。  </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="n">algo</span> <span class="o">=</span> <span class="n">TargetPercentPipeAlgo</span><span class="p">(</span>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a>                     <span class="n">start_session</span><span class="o">=</span><span class="n">algo_start_dt</span><span class="p">,</span>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>                     <span class="n">end_session</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span>
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a>                     <span class="n">allow_short</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a>                     <span class="n">cancel_datedelta</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a>                     <span class="n">pipeline</span><span class="o">=</span><span class="n">make_pipeline</span><span class="p">,</span>
<a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a><span class="p">)</span>
<a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a>
<a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a><span class="c1"># set_algo_instance</span>
<a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a><span class="n">set_algo_instance</span><span class="p">(</span><span class="n">algo</span><span class="p">)</span>
<a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a>
<a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a><span class="c1"># run</span>
<a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a><span class="n">stats</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>[2024-03-13 02:41:06.883576]: INFO: earn_dividends: Equity(6 [1590]), cash_dividend amount: 13.43905496, pay_date: 2023-10-30, div_owed: 54414.73353304
[2024-03-13 02:41:06.883576]: INFO: handle_split: after split: asset: Equity(6 [1590]), amount: 4047, cost_basis: 982.73, last_sale_price: 981.0
[2024-03-13 02:41:06.883576]: INFO: handle_split: returning cash: 648.82
[2024-03-13 02:41:06.951237]: INFO: handle_simulation_end: Simulated 8 trading days
first open: 2023-09-21 01:01:00+00:00
last close: 2023-10-03 05:30:00+00:00
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="n">result</span> <span class="o">=</span> <span class="n">run_pipeline</span><span class="p">(</span><span class="n">make_pipeline</span><span class="p">(),</span> <span class="n">algo_start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="n">result</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(longs == True) | (shorts == True)&#39;</span> <span class="p">)</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>longs</th>
      <th>shorts</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="4" valign="top">2023-09-22 00:00:00+00:00</th>
      <th>Equity(6 [1590])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(10 [2301])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(24 [2603])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(39 [2912])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">2023-09-25 00:00:00+00:00</th>
      <th>Equity(10 [2301])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(25 [2609])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(31 [2883])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(34 [2886])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">2023-09-26 00:00:00+00:00</th>
      <th>Equity(8 [2002])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(10 [2301])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(33 [2885])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(34 [2886])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">2023-09-27 00:00:00+00:00</th>
      <th>Equity(10 [2301])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(17 [2357])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(25 [2609])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(34 [2886])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">2023-09-28 00:00:00+00:00</th>
      <th>Equity(6 [1590])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(10 [2301])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(34 [2886])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(39 [2912])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">2023-10-02 00:00:00+00:00</th>
      <th>Equity(10 [2301])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(24 [2603])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(34 [2886])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(39 [2912])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">2023-10-03 00:00:00+00:00</th>
      <th>Equity(2 [1301])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(6 [1590])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(14 [2327])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(30 [2882])</th>
      <td>False</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="n">positions</span><span class="p">,</span> <span class="n">transactions</span><span class="p">,</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">get_transaction_detail</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="n">orders</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(symbol == &quot;2912&quot;) &amp; (created.dt.strftime(&quot;%Y-%m-</span><span class="si">%d</span><span class="s1">&quot;) == &quot;2023-09-28&quot;)&#39;</span><span class="p">)</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sid</th>
      <th>symbol</th>
      <th>id</th>
      <th>dt</th>
      <th>reason</th>
      <th>created</th>
      <th>amount</th>
      <th>filled</th>
      <th>commission</th>
      <th>stop</th>
      <th>limit</th>
      <th>stop_reached</th>
      <th>limit_reached</th>
      <th>asset</th>
      <th>status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-09-28 13:30:00+08:00</th>
      <td>39</td>
      <td>2912</td>
      <td>05ab5284f0904f0599fce02cafe7dd93</td>
      <td>2023-09-28 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-09-28 13:30:00+08:00</td>
      <td>-14660</td>
      <td>0</td>
      <td>0.0</td>
      <td>None</td>
      <td>None</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(39 [2912])</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2023-10-02 13:30:00+08:00</th>
      <td>39</td>
      <td>2912</td>
      <td>05ab5284f0904f0599fce02cafe7dd93</td>
      <td>2023-10-02 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-09-28 13:30:00+08:00</td>
      <td>-14660</td>
      <td>-8575</td>
      <td>9980.0</td>
      <td>None</td>
      <td>None</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(39 [2912])</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2023-10-03 13:30:00+08:00</th>
      <td>39</td>
      <td>2912</td>
      <td>05ab5284f0904f0599fce02cafe7dd93</td>
      <td>2023-10-03 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-09-28 13:30:00+08:00</td>
      <td>-14660</td>
      <td>-14660</td>
      <td>17035.0</td>
      <td>None</td>
      <td>None</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(39 [2912])</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="c1"># 10/02：343000 * 2.5% = 8575(股) </span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="c1"># 10/03：808000 * 2.5% = 20200(股) </span>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="n">df_bundle_price</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(symbol == &quot;2912&quot;) &amp; (date.dt.strftime(&quot;%Y-%m-</span><span class="si">%d</span><span class="s1">&quot;)&gt;=&quot;2023-10-02&quot;)&#39;</span><span class="p">)</span>\
<a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a>                 <span class="p">[[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;volume&#39;</span><span class="p">]]</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>symbol</th>
      <th>date</th>
      <th>volume</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>4687</th>
      <td>2912</td>
      <td>2023-10-02 00:00:00+00:00</td>
      <td>343000.0</td>
    </tr>
    <tr>
      <th>4743</th>
      <td>2912</td>
      <td>2023-10-03 00:00:00+00:00</td>
      <td>808000.0</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="n">positions</span><span class="p">[</span><span class="s1">&#39;mv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">positions</span><span class="p">[</span><span class="s1">&#39;last_sale_price&#39;</span><span class="p">]</span>
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="n">positions</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(symbol == &quot;2912&quot;)&#39;</span><span class="p">)</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sid</th>
      <th>symbol</th>
      <th>asset</th>
      <th>amount</th>
      <th>cost_basis</th>
      <th>last_sale_price</th>
      <th>mv</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-09-25 13:30:00+08:00</th>
      <td>39</td>
      <td>2912</td>
      <td>Equity(39 [2912])</td>
      <td>-15079</td>
      <td>263.315631</td>
      <td>264.5</td>
      <td>-3988395.5</td>
    </tr>
    <tr>
      <th>2023-10-02 13:30:00+08:00</th>
      <td>39</td>
      <td>2912</td>
      <td>Equity(39 [2912])</td>
      <td>-8575</td>
      <td>261.819714</td>
      <td>263.0</td>
      <td>-2255225.0</td>
    </tr>
    <tr>
      <th>2023-10-03 13:30:00+08:00</th>
      <td>39</td>
      <td>2912</td>
      <td>Equity(39 [2912])</td>
      <td>-14660</td>
      <td>261.412688</td>
      <td>262.0</td>
      <td>-3840920.0</td>
    </tr>
  </tbody>
</table>
</div>

<p><span id="Case10"></span></p>
<h2 id="case-10-limit_buy_multiplier">Case 10 調整limit_buy_multiplier</h2>
<p><a href="#menu">Return to Menu</a> </p>
<p>接續<strong>Case 9</strong>，多設定<code>limit_buy_multiplier=1.015</code>，其餘與<strong>Case 9</strong>相同。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="n">result</span> <span class="o">=</span> <span class="n">run_pipeline</span><span class="p">(</span><span class="n">make_pipeline</span><span class="p">(),</span> <span class="n">algo_start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
<a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a><span class="n">result</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(longs == True) | (shorts == True)&#39;</span> <span class="p">)</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>longs</th>
      <th>shorts</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="4" valign="top">2023-09-22 00:00:00+00:00</th>
      <th>Equity(6 [1590])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(10 [2301])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(24 [2603])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(39 [2912])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">2023-09-25 00:00:00+00:00</th>
      <th>Equity(10 [2301])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(25 [2609])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(31 [2883])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(34 [2886])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">2023-09-26 00:00:00+00:00</th>
      <th>Equity(8 [2002])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(10 [2301])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(33 [2885])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(34 [2886])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">2023-09-27 00:00:00+00:00</th>
      <th>Equity(10 [2301])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(17 [2357])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(25 [2609])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(34 [2886])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">2023-09-28 00:00:00+00:00</th>
      <th>Equity(6 [1590])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(10 [2301])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(34 [2886])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(39 [2912])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">2023-10-02 00:00:00+00:00</th>
      <th>Equity(10 [2301])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(24 [2603])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(34 [2886])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(39 [2912])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">2023-10-03 00:00:00+00:00</th>
      <th>Equity(2 [1301])</th>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>Equity(6 [1590])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(14 [2327])</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>Equity(30 [2882])</th>
      <td>False</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="n">algo</span> <span class="o">=</span> <span class="n">TargetPercentPipeAlgo</span><span class="p">(</span>
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a>                     <span class="n">start_session</span><span class="o">=</span><span class="n">algo_start_dt</span><span class="p">,</span>
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a>                     <span class="n">end_session</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span>
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a>                     <span class="n">limit_buy_multiplier</span><span class="o">=</span><span class="mf">1.015</span><span class="p">,</span>
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a>                     <span class="n">allow_short</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a>                     <span class="n">cancel_datedelta</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a>                     <span class="n">pipeline</span><span class="o">=</span><span class="n">make_pipeline</span><span class="p">,</span>
<a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a><span class="p">)</span>
<a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a>
<a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a><span class="c1"># set_algo_instance</span>
<a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a><span class="n">set_algo_instance</span><span class="p">(</span><span class="n">algo</span><span class="p">)</span>
<a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a>
<a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a><span class="c1"># run</span>
<a id="__codelineno-60-14" name="__codelineno-60-14" href="#__codelineno-60-14"></a><span class="n">stats</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>[2024-03-13 02:41:07.183718]: INFO: earn_dividends: Equity(6 [1590]), cash_dividend amount: 13.43905496, pay_date: 2023-10-30, div_owed: 54414.73353304
[2024-03-13 02:41:07.183718]: INFO: handle_split: after split: asset: Equity(6 [1590]), amount: 4047, cost_basis: 982.73, last_sale_price: 981.0
[2024-03-13 02:41:07.183718]: INFO: handle_split: returning cash: 648.82
[2024-03-13 02:41:07.254114]: INFO: exec_cancel: Cancel_order: current time: 2023-10-03,
                              due to : created&gt;=current time + cancel_datedelta(2 days),
                              created: 2023-09-28, asset: Equity(6 [1590]), amount: 3931, filled: 0&#39;
[2024-03-13 02:41:07.259895]: INFO: handle_simulation_end: Simulated 8 trading days
first open: 2023-09-21 01:01:00+00:00
last close: 2023-10-03 05:30:00+00:00
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="n">positions</span><span class="p">,</span> <span class="n">transactions</span><span class="p">,</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">get_transaction_detail</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="n">orders</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sid</th>
      <th>symbol</th>
      <th>id</th>
      <th>dt</th>
      <th>reason</th>
      <th>created</th>
      <th>amount</th>
      <th>filled</th>
      <th>commission</th>
      <th>stop</th>
      <th>limit</th>
      <th>stop_reached</th>
      <th>limit_reached</th>
      <th>asset</th>
      <th>status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-09-21 13:30:00+08:00</th>
      <td>34</td>
      <td>2886</td>
      <td>5e4ce9d6633d408a9389b175c652626b</td>
      <td>2023-09-21 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-09-21 13:30:00+08:00</td>
      <td>106951</td>
      <td>0</td>
      <td>0.0</td>
      <td>None</td>
      <td>37.96</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(34 [2886])</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2023-09-21 13:30:00+08:00</th>
      <td>46</td>
      <td>4904</td>
      <td>e0b2c8d022ff41959b6f077bccad0c43</td>
      <td>2023-09-21 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-09-21 13:30:00+08:00</td>
      <td>55478</td>
      <td>0</td>
      <td>0.0</td>
      <td>None</td>
      <td>73.18</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(46 [4904])</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2023-09-21 13:30:00+08:00</th>
      <td>10</td>
      <td>2301</td>
      <td>25b053b3403b4ec4aa3408745f592ac4</td>
      <td>2023-09-21 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-09-21 13:30:00+08:00</td>
      <td>-33613</td>
      <td>0</td>
      <td>0.0</td>
      <td>None</td>
      <td>NaN</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(10 [2301])</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2023-09-21 13:30:00+08:00</th>
      <td>44</td>
      <td>3231</td>
      <td>7a065d9e8d604f699ec3efd6ca41d47c</td>
      <td>2023-09-21 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-09-21 13:30:00+08:00</td>
      <td>-39800</td>
      <td>0</td>
      <td>0.0</td>
      <td>None</td>
      <td>NaN</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(44 [3231])</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2023-09-22 13:30:00+08:00</th>
      <td>34</td>
      <td>2886</td>
      <td>5e4ce9d6633d408a9389b175c652626b</td>
      <td>2023-09-22 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-09-21 13:30:00+08:00</td>
      <td>106951</td>
      <td>106951</td>
      <td>5761.0</td>
      <td>None</td>
      <td>37.96</td>
      <td>False</td>
      <td>True</td>
      <td>Equity(34 [2886])</td>
      <td>1</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2023-10-03 13:30:00+08:00</th>
      <td>39</td>
      <td>2912</td>
      <td>aaa092b0d9954807a887fab5edbed96e</td>
      <td>2023-10-03 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-10-03 13:30:00+08:00</td>
      <td>14660</td>
      <td>0</td>
      <td>0.0</td>
      <td>None</td>
      <td>NaN</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(39 [2912])</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2023-10-03 13:30:00+08:00</th>
      <td>6</td>
      <td>1590</td>
      <td>01f05fe434e643268c1562ae1004734a</td>
      <td>2023-10-03 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-10-03 13:30:00+08:00</td>
      <td>3762</td>
      <td>0</td>
      <td>0.0</td>
      <td>None</td>
      <td>1012.97</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(6 [1590])</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2023-10-03 13:30:00+08:00</th>
      <td>14</td>
      <td>2327</td>
      <td>606f2de8c38d4be484df5d6889fe5e28</td>
      <td>2023-10-03 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-10-03 13:30:00+08:00</td>
      <td>7221</td>
      <td>0</td>
      <td>0.0</td>
      <td>None</td>
      <td>527.80</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(14 [2327])</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2023-10-03 13:30:00+08:00</th>
      <td>2</td>
      <td>1301</td>
      <td>d5aa6f02906f4e008bceac04ade72d21</td>
      <td>2023-10-03 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-10-03 13:30:00+08:00</td>
      <td>-47471</td>
      <td>0</td>
      <td>0.0</td>
      <td>None</td>
      <td>NaN</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(2 [1301])</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2023-10-03 13:30:00+08:00</th>
      <td>30</td>
      <td>2882</td>
      <td>82adef75477d4095beaf6b4e02657dcb</td>
      <td>2023-10-03 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-10-03 13:30:00+08:00</td>
      <td>-85340</td>
      <td>0</td>
      <td>0.0</td>
      <td>None</td>
      <td>NaN</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(30 [2882])</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>92 rows × 15 columns</p>
</div>

<div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="n">orders</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(symbol == &quot;1590&quot;) &amp; (created.dt.strftime(&quot;%Y-%m-</span><span class="si">%d</span><span class="s1">&quot;) == &quot;2023-09-28&quot;)&#39;</span><span class="p">)</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sid</th>
      <th>symbol</th>
      <th>id</th>
      <th>dt</th>
      <th>reason</th>
      <th>created</th>
      <th>amount</th>
      <th>filled</th>
      <th>commission</th>
      <th>stop</th>
      <th>limit</th>
      <th>stop_reached</th>
      <th>limit_reached</th>
      <th>asset</th>
      <th>status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-09-28 13:30:00+08:00</th>
      <td>6</td>
      <td>1590</td>
      <td>7a1633e9d2314561bf5fc6b235784201</td>
      <td>2023-09-28 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-09-28 13:30:00+08:00</td>
      <td>3931</td>
      <td>0</td>
      <td>0.0</td>
      <td>None</td>
      <td>993.68</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(6 [1590])</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2023-10-03 13:30:00+08:00</th>
      <td>6</td>
      <td>1590</td>
      <td>7a1633e9d2314561bf5fc6b235784201</td>
      <td>2023-10-03 13:30:00+08:00</td>
      <td>None</td>
      <td>2023-09-28 13:30:00+08:00</td>
      <td>3931</td>
      <td>0</td>
      <td>0.0</td>
      <td>None</td>
      <td>993.68</td>
      <td>False</td>
      <td>False</td>
      <td>Equity(6 [1590])</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="c1"># 9/28 979 * 1.015 = 993.685</span>
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="n">df_bundle_price</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(symbol == &quot;1590&quot;) &amp; (date.dt.strftime(&quot;%Y-%m-</span><span class="si">%d</span><span class="s1">&quot;)&gt;=&quot;2023-09-28&quot;)&#39;</span><span class="p">)</span>\
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a>                 <span class="p">[[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;close&#39;</span><span class="p">]]</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>symbol</th>
      <th>date</th>
      <th>close</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>4598</th>
      <td>1590</td>
      <td>2023-09-28 00:00:00+00:00</td>
      <td>979.0</td>
    </tr>
    <tr>
      <th>4654</th>
      <td>1590</td>
      <td>2023-10-02 00:00:00+00:00</td>
      <td>1005.0</td>
    </tr>
    <tr>
      <th>4710</th>
      <td>1590</td>
      <td>2023-10-03 00:00:00+00:00</td>
      <td>998.0</td>
    </tr>
  </tbody>
</table>
</div>

<p><span id="Case11"></span></p>
<h2 id="case-11-custom_weightanalyzerecord_varsget_record_varsget_transaction_detail">Case 11 調整custom_weight、analyze、record_vars、get_record_vars與get_transaction_detail</h2>
<p><a href="#menu">Return to Menu</a> </p>
<p>接續<strong>Case 10</strong>，多設定<code>custom_weight</code>=True、<code>analyze</code>、<code>record_vars</code>、<code>get_record_vars</code>=True與<code>get_transaction_detail</code>=True，其餘與<strong>Case 10</strong>相同。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="k">class</span> <span class="nc">Weight</span><span class="p">(</span><span class="n">CustomFactor</span><span class="p">):</span>
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>
<a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a>    <span class="n">inputs</span> <span class="o">=</span>  <span class="p">[</span><span class="n">TQAltDataSet</span><span class="o">.</span><span class="n">Market_Cap_Dollars</span><span class="p">]</span> 
<a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a>    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Market_Cap_Dollars&quot;</span><span class="p">,</span><span class="s2">&quot;Sum_Market_Cap_Dollars&quot;</span><span class="p">,</span><span class="s2">&quot;Weight&quot;</span><span class="p">]</span>   
<a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a>    <span class="n">window_length</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a>
<a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">today</span><span class="p">,</span> <span class="n">assets</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">Market_Cap_Dollars</span><span class="p">):</span>
<a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a>
<a id="__codelineno-65-9" name="__codelineno-65-9" href="#__codelineno-65-9"></a>        <span class="n">out</span><span class="o">.</span><span class="n">Market_Cap_Dollars</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">Market_Cap_Dollars</span>
<a id="__codelineno-65-10" name="__codelineno-65-10" href="#__codelineno-65-10"></a>        <span class="n">out</span><span class="o">.</span><span class="n">Sum_Market_Cap_Dollars</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">Market_Cap_Dollars</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-65-11" name="__codelineno-65-11" href="#__codelineno-65-11"></a>        <span class="n">out</span><span class="o">.</span><span class="n">Weight</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">Market_Cap_Dollars</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Market_Cap_Dollars</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="k">def</span> <span class="nf">make_pipeline</span><span class="p">():</span>
<a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a>
<a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a>    <span class="n">rsi</span> <span class="o">=</span> <span class="n">RSI</span><span class="p">()</span>
<a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a>    <span class="n">longs</span> <span class="o">=</span> <span class="n">rsi</span><span class="o">.</span><span class="n">top</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">SingleAsset</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">asset_finder</span><span class="o">.</span><span class="n">lookup_symbol</span><span class="p">(</span><span class="s1">&#39;IR0001&#39;</span><span class="p">,</span> <span class="n">as_of_date</span><span class="o">=</span><span class="kc">None</span><span class="p">)))</span>
<a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a>    <span class="n">shorts</span> <span class="o">=</span> <span class="n">rsi</span><span class="o">.</span><span class="n">bottom</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">SingleAsset</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">asset_finder</span><span class="o">.</span><span class="n">lookup_symbol</span><span class="p">(</span><span class="s1">&#39;IR0001&#39;</span><span class="p">,</span> <span class="n">as_of_date</span><span class="o">=</span><span class="kc">None</span><span class="p">)))</span>
<a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a>
<a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a>    <span class="k">return</span> <span class="n">Pipeline</span><span class="p">(</span>
<a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a>
<a id="__codelineno-66-9" name="__codelineno-66-9" href="#__codelineno-66-9"></a>        <span class="n">columns</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-66-10" name="__codelineno-66-10" href="#__codelineno-66-10"></a>            <span class="s2">&quot;Market_Cap_Dollars&quot;</span><span class="p">:</span><span class="n">Weight</span><span class="p">()</span><span class="o">.</span><span class="n">Market_Cap_Dollars</span><span class="p">,</span>        
<a id="__codelineno-66-11" name="__codelineno-66-11" href="#__codelineno-66-11"></a>            <span class="s2">&quot;longs&quot;</span> <span class="p">:</span> <span class="n">longs</span><span class="p">,</span>
<a id="__codelineno-66-12" name="__codelineno-66-12" href="#__codelineno-66-12"></a>            <span class="s2">&quot;shorts&quot;</span> <span class="p">:</span> <span class="n">shorts</span><span class="p">,</span>
<a id="__codelineno-66-13" name="__codelineno-66-13" href="#__codelineno-66-13"></a>            <span class="s2">&quot;long_weights&quot;</span> <span class="p">:</span> <span class="n">Weight</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="n">longs</span><span class="p">)</span><span class="o">.</span><span class="n">Weight</span><span class="p">,</span>
<a id="__codelineno-66-14" name="__codelineno-66-14" href="#__codelineno-66-14"></a>            <span class="s2">&quot;short_weights&quot;</span> <span class="p">:</span> <span class="n">Weight</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="n">shorts</span><span class="p">)</span><span class="o">.</span><span class="n">Weight</span>
<a id="__codelineno-66-15" name="__codelineno-66-15" href="#__codelineno-66-15"></a>        <span class="p">}</span>
<a id="__codelineno-66-16" name="__codelineno-66-16" href="#__codelineno-66-16"></a>    <span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="k">def</span> <span class="nf">analyze</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">perf</span><span class="p">):</span>
<a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a>
<a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a>    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
<a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a>
<a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a>    <span class="c1"># First chart(累積報酬)</span>
<a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a>    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">611</span><span class="p">)</span> 
<a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Strategy Results&#39;</span><span class="p">)</span> 
<a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">perf</span><span class="p">[</span><span class="s1">&#39;algorithm_period_return&#39;</span><span class="p">],</span>
<a id="__codelineno-67-9" name="__codelineno-67-9" href="#__codelineno-67-9"></a>            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> 
<a id="__codelineno-67-10" name="__codelineno-67-10" href="#__codelineno-67-10"></a>            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;algorithm period return&#39;</span><span class="p">,</span>
<a id="__codelineno-67-11" name="__codelineno-67-11" href="#__codelineno-67-11"></a>            <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
<a id="__codelineno-67-12" name="__codelineno-67-12" href="#__codelineno-67-12"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">perf</span><span class="p">[</span><span class="s1">&#39;benchmark_period_return&#39;</span><span class="p">],</span>
<a id="__codelineno-67-13" name="__codelineno-67-13" href="#__codelineno-67-13"></a>            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> 
<a id="__codelineno-67-14" name="__codelineno-67-14" href="#__codelineno-67-14"></a>            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;benchmark period return&#39;</span><span class="p">,</span>
<a id="__codelineno-67-15" name="__codelineno-67-15" href="#__codelineno-67-15"></a>            <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
<a id="__codelineno-67-16" name="__codelineno-67-16" href="#__codelineno-67-16"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<a id="__codelineno-67-17" name="__codelineno-67-17" href="#__codelineno-67-17"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-67-18" name="__codelineno-67-18" href="#__codelineno-67-18"></a>
<a id="__codelineno-67-19" name="__codelineno-67-19" href="#__codelineno-67-19"></a>    <span class="c1"># Second chart(returns)</span>
<a id="__codelineno-67-20" name="__codelineno-67-20" href="#__codelineno-67-20"></a>    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">612</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>       
<a id="__codelineno-67-21" name="__codelineno-67-21" href="#__codelineno-67-21"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">perf</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">],</span>
<a id="__codelineno-67-22" name="__codelineno-67-22" href="#__codelineno-67-22"></a>            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> 
<a id="__codelineno-67-23" name="__codelineno-67-23" href="#__codelineno-67-23"></a>            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;returns&#39;</span><span class="p">,</span>
<a id="__codelineno-67-24" name="__codelineno-67-24" href="#__codelineno-67-24"></a>            <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
<a id="__codelineno-67-25" name="__codelineno-67-25" href="#__codelineno-67-25"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<a id="__codelineno-67-26" name="__codelineno-67-26" href="#__codelineno-67-26"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-67-27" name="__codelineno-67-27" href="#__codelineno-67-27"></a>
<a id="__codelineno-67-28" name="__codelineno-67-28" href="#__codelineno-67-28"></a>    <span class="c1"># Third chart(ending_cash) -&gt; 觀察是否超買</span>
<a id="__codelineno-67-29" name="__codelineno-67-29" href="#__codelineno-67-29"></a>    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">613</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<a id="__codelineno-67-30" name="__codelineno-67-30" href="#__codelineno-67-30"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">perf</span><span class="p">[</span><span class="s1">&#39;ending_cash&#39;</span><span class="p">],</span> 
<a id="__codelineno-67-31" name="__codelineno-67-31" href="#__codelineno-67-31"></a>            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ending_cash&#39;</span><span class="p">,</span>
<a id="__codelineno-67-32" name="__codelineno-67-32" href="#__codelineno-67-32"></a>            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
<a id="__codelineno-67-33" name="__codelineno-67-33" href="#__codelineno-67-33"></a>            <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
<a id="__codelineno-67-34" name="__codelineno-67-34" href="#__codelineno-67-34"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-67-35" name="__codelineno-67-35" href="#__codelineno-67-35"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<a id="__codelineno-67-36" name="__codelineno-67-36" href="#__codelineno-67-36"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-67-37" name="__codelineno-67-37" href="#__codelineno-67-37"></a>
<a id="__codelineno-67-38" name="__codelineno-67-38" href="#__codelineno-67-38"></a>    <span class="c1"># Forth chart(shorts_count) -&gt; 觀察是否放空</span>
<a id="__codelineno-67-39" name="__codelineno-67-39" href="#__codelineno-67-39"></a>    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">614</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<a id="__codelineno-67-40" name="__codelineno-67-40" href="#__codelineno-67-40"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">perf</span><span class="p">[</span><span class="s1">&#39;shorts_count&#39;</span><span class="p">],</span> 
<a id="__codelineno-67-41" name="__codelineno-67-41" href="#__codelineno-67-41"></a>            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;shorts_count&#39;</span><span class="p">,</span>
<a id="__codelineno-67-42" name="__codelineno-67-42" href="#__codelineno-67-42"></a>            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
<a id="__codelineno-67-43" name="__codelineno-67-43" href="#__codelineno-67-43"></a>            <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
<a id="__codelineno-67-44" name="__codelineno-67-44" href="#__codelineno-67-44"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">integer</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<a id="__codelineno-67-45" name="__codelineno-67-45" href="#__codelineno-67-45"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-67-46" name="__codelineno-67-46" href="#__codelineno-67-46"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<a id="__codelineno-67-47" name="__codelineno-67-47" href="#__codelineno-67-47"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-67-48" name="__codelineno-67-48" href="#__codelineno-67-48"></a>
<a id="__codelineno-67-49" name="__codelineno-67-49" href="#__codelineno-67-49"></a>    <span class="c1"># Fifth chart(longs_count)</span>
<a id="__codelineno-67-50" name="__codelineno-67-50" href="#__codelineno-67-50"></a>    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">615</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<a id="__codelineno-67-51" name="__codelineno-67-51" href="#__codelineno-67-51"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">perf</span><span class="p">[</span><span class="s1">&#39;longs_count&#39;</span><span class="p">],</span> 
<a id="__codelineno-67-52" name="__codelineno-67-52" href="#__codelineno-67-52"></a>            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;longs_count&#39;</span><span class="p">,</span>
<a id="__codelineno-67-53" name="__codelineno-67-53" href="#__codelineno-67-53"></a>            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
<a id="__codelineno-67-54" name="__codelineno-67-54" href="#__codelineno-67-54"></a>            <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
<a id="__codelineno-67-55" name="__codelineno-67-55" href="#__codelineno-67-55"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">integer</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<a id="__codelineno-67-56" name="__codelineno-67-56" href="#__codelineno-67-56"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-67-57" name="__codelineno-67-57" href="#__codelineno-67-57"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<a id="__codelineno-67-58" name="__codelineno-67-58" href="#__codelineno-67-58"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span> 
<a id="__codelineno-67-59" name="__codelineno-67-59" href="#__codelineno-67-59"></a>
<a id="__codelineno-67-60" name="__codelineno-67-60" href="#__codelineno-67-60"></a>    <span class="c1"># Sixth chart(weights) -&gt; 觀察每日持股權重</span>
<a id="__codelineno-67-61" name="__codelineno-67-61" href="#__codelineno-67-61"></a>    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">616</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>        
<a id="__codelineno-67-62" name="__codelineno-67-62" href="#__codelineno-67-62"></a>    <span class="n">weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">perf</span><span class="p">[</span><span class="s1">&#39;daily_weights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<a id="__codelineno-67-63" name="__codelineno-67-63" href="#__codelineno-67-63"></a>
<a id="__codelineno-67-64" name="__codelineno-67-64" href="#__codelineno-67-64"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-67-65" name="__codelineno-67-65" href="#__codelineno-67-65"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
<a id="__codelineno-67-66" name="__codelineno-67-66" href="#__codelineno-67-66"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;daily_weights&#39;</span><span class="p">)</span>
<a id="__codelineno-67-67" name="__codelineno-67-67" href="#__codelineno-67-67"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-67-68" name="__codelineno-67-68" href="#__codelineno-67-68"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;daily_weights&#39;</span><span class="p">])</span>
<a id="__codelineno-67-69" name="__codelineno-67-69" href="#__codelineno-67-69"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-67-70" name="__codelineno-67-70" href="#__codelineno-67-70"></a>
<a id="__codelineno-67-71" name="__codelineno-67-71" href="#__codelineno-67-71"></a>    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<a id="__codelineno-67-72" name="__codelineno-67-72" href="#__codelineno-67-72"></a>
<a id="__codelineno-67-73" name="__codelineno-67-73" href="#__codelineno-67-73"></a><span class="k">def</span> <span class="nf">record_vars</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<a id="__codelineno-67-74" name="__codelineno-67-74" href="#__codelineno-67-74"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-67-75" name="__codelineno-67-75" href="#__codelineno-67-75"></a><span class="sd">    Plot variables at the end of each day.</span>
<a id="__codelineno-67-76" name="__codelineno-67-76" href="#__codelineno-67-76"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-67-77" name="__codelineno-67-77" href="#__codelineno-67-77"></a>
<a id="__codelineno-67-78" name="__codelineno-67-78" href="#__codelineno-67-78"></a>    <span class="n">record</span><span class="p">(</span><span class="n">daily_weights</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">daily_weights</span><span class="p">,</span>
<a id="__codelineno-67-79" name="__codelineno-67-79" href="#__codelineno-67-79"></a>           <span class="n">Market_Cap_Dollars</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">Market_Cap_Dollars</span>
<a id="__codelineno-67-80" name="__codelineno-67-80" href="#__codelineno-67-80"></a>          <span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="n">algo</span> <span class="o">=</span> <span class="n">TargetPercentPipeAlgo</span><span class="p">(</span>
<a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a>                     <span class="n">start_session</span><span class="o">=</span><span class="n">algo_start_dt</span><span class="p">,</span>
<a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a>                     <span class="n">end_session</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span>
<a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a>                     <span class="n">limit_buy_multiplier</span><span class="o">=</span><span class="mf">1.015</span><span class="p">,</span>
<a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a>                     <span class="n">allow_short</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a>                     <span class="n">custom_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a>                     <span class="n">cancel_datedelta</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a>                     <span class="n">pipeline</span><span class="o">=</span><span class="n">make_pipeline</span><span class="p">,</span>
<a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a>                     <span class="n">analyze</span><span class="o">=</span><span class="n">analyze</span><span class="p">,</span>
<a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a>                     <span class="n">record_vars</span><span class="o">=</span><span class="n">record_vars</span><span class="p">,</span>
<a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a>                     <span class="n">get_record_vars</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-68-12" name="__codelineno-68-12" href="#__codelineno-68-12"></a>                     <span class="n">get_transaction_detail</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-68-13" name="__codelineno-68-13" href="#__codelineno-68-13"></a><span class="p">)</span>
<a id="__codelineno-68-14" name="__codelineno-68-14" href="#__codelineno-68-14"></a>
<a id="__codelineno-68-15" name="__codelineno-68-15" href="#__codelineno-68-15"></a><span class="c1"># set_algo_instance</span>
<a id="__codelineno-68-16" name="__codelineno-68-16" href="#__codelineno-68-16"></a><span class="n">set_algo_instance</span><span class="p">(</span><span class="n">algo</span><span class="p">)</span>
<a id="__codelineno-68-17" name="__codelineno-68-17" href="#__codelineno-68-17"></a>
<a id="__codelineno-68-18" name="__codelineno-68-18" href="#__codelineno-68-18"></a><span class="c1"># run</span>
<a id="__codelineno-68-19" name="__codelineno-68-19" href="#__codelineno-68-19"></a><span class="n">stats</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>[2024-03-13 02:41:07.483598]: INFO: earn_dividends: Equity(6 [1590]), cash_dividend amount: 13.43905496, pay_date: 2023-10-30, div_owed: 48703.13517504
[2024-03-13 02:41:07.483598]: INFO: handle_split: after split: asset: Equity(6 [1590]), amount: 3622, cost_basis: 982.73, last_sale_price: 981.0
[2024-03-13 02:41:07.483598]: INFO: handle_split: returning cash: 787.02
[2024-03-13 02:41:07.583608]: INFO: exec_cancel: Cancel_order: current time: 2023-10-03,
                              due to : created&gt;=current time + cancel_datedelta(2 days),
                              created: 2023-09-28, asset: Equity(6 [1590]), amount: 2145, filled: 0&#39;
[2024-03-13 02:41:07.600275]: INFO: handle_simulation_end: Simulated 8 trading days
first open: 2023-09-21 01:01:00+00:00
last close: 2023-10-03 05:30:00+00:00
</code></pre></div>
<p><img alt="png" src="output_92_1.png" /></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="n">result</span> <span class="o">=</span> <span class="n">run_pipeline</span><span class="p">(</span><span class="n">make_pipeline</span><span class="p">(),</span> <span class="n">algo_start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
<a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="n">result</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(longs == True) | (shorts == True)&#39;</span> <span class="p">)</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>Market_Cap_Dollars</th>
      <th>longs</th>
      <th>shorts</th>
      <th>long_weights</th>
      <th>short_weights</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="4" valign="top">2023-09-22 00:00:00+00:00</th>
      <th>Equity(6 [1590])</th>
      <td>1.980000e+11</td>
      <td>True</td>
      <td>False</td>
      <td>0.447512</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>Equity(10 [2301])</th>
      <td>2.818339e+11</td>
      <td>False</td>
      <td>True</td>
      <td>NaN</td>
      <td>0.507101</td>
    </tr>
    <tr>
      <th>Equity(24 [2603])</th>
      <td>2.444465e+11</td>
      <td>True</td>
      <td>False</td>
      <td>0.552488</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>Equity(39 [2912])</th>
      <td>2.739405e+11</td>
      <td>False</td>
      <td>True</td>
      <td>NaN</td>
      <td>0.492899</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">2023-09-25 00:00:00+00:00</th>
      <th>Equity(10 [2301])</th>
      <td>2.842023e+11</td>
      <td>False</td>
      <td>True</td>
      <td>NaN</td>
      <td>0.590585</td>
    </tr>
    <tr>
      <th>Equity(25 [2609])</th>
      <td>1.599384e+11</td>
      <td>True</td>
      <td>False</td>
      <td>0.231433</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>Equity(31 [2883])</th>
      <td>1.970197e+11</td>
      <td>False</td>
      <td>True</td>
      <td>NaN</td>
      <td>0.409415</td>
    </tr>
    <tr>
      <th>Equity(34 [2886])</th>
      <td>5.311406e+11</td>
      <td>True</td>
      <td>False</td>
      <td>0.768567</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">2023-09-26 00:00:00+00:00</th>
      <th>Equity(8 [2002])</th>
      <td>4.122534e+11</td>
      <td>False</td>
      <td>True</td>
      <td>NaN</td>
      <td>0.591931</td>
    </tr>
    <tr>
      <th>Equity(10 [2301])</th>
      <td>2.842023e+11</td>
      <td>False</td>
      <td>True</td>
      <td>NaN</td>
      <td>0.408069</td>
    </tr>
    <tr>
      <th>Equity(33 [2885])</th>
      <td>3.197649e+11</td>
      <td>True</td>
      <td>False</td>
      <td>0.374557</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>Equity(34 [2886])</th>
      <td>5.339508e+11</td>
      <td>True</td>
      <td>False</td>
      <td>0.625443</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">2023-09-27 00:00:00+00:00</th>
      <th>Equity(10 [2301])</th>
      <td>2.842023e+11</td>
      <td>False</td>
      <td>True</td>
      <td>NaN</td>
      <td>0.516628</td>
    </tr>
    <tr>
      <th>Equity(17 [2357])</th>
      <td>2.659082e+11</td>
      <td>False</td>
      <td>True</td>
      <td>NaN</td>
      <td>0.483372</td>
    </tr>
    <tr>
      <th>Equity(25 [2609])</th>
      <td>1.604622e+11</td>
      <td>True</td>
      <td>False</td>
      <td>0.231780</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>Equity(34 [2886])</th>
      <td>5.318431e+11</td>
      <td>True</td>
      <td>False</td>
      <td>0.768220</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">2023-09-28 00:00:00+00:00</th>
      <th>Equity(6 [1590])</th>
      <td>1.982000e+11</td>
      <td>True</td>
      <td>False</td>
      <td>0.272277</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>Equity(10 [2301])</th>
      <td>2.842023e+11</td>
      <td>False</td>
      <td>True</td>
      <td>NaN</td>
      <td>0.509667</td>
    </tr>
    <tr>
      <th>Equity(34 [2886])</th>
      <td>5.297354e+11</td>
      <td>True</td>
      <td>False</td>
      <td>0.727723</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>Equity(39 [2912])</th>
      <td>2.734207e+11</td>
      <td>False</td>
      <td>True</td>
      <td>NaN</td>
      <td>0.490333</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">2023-10-02 00:00:00+00:00</th>
      <th>Equity(10 [2301])</th>
      <td>2.877548e+11</td>
      <td>False</td>
      <td>True</td>
      <td>NaN</td>
      <td>0.513247</td>
    </tr>
    <tr>
      <th>Equity(24 [2603])</th>
      <td>2.455047e+11</td>
      <td>True</td>
      <td>False</td>
      <td>0.316682</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>Equity(34 [2886])</th>
      <td>5.297354e+11</td>
      <td>True</td>
      <td>False</td>
      <td>0.683318</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>Equity(39 [2912])</th>
      <td>2.729008e+11</td>
      <td>False</td>
      <td>True</td>
      <td>NaN</td>
      <td>0.486753</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">2023-10-03 00:00:00+00:00</th>
      <th>Equity(2 [1301])</th>
      <td>5.067130e+11</td>
      <td>False</td>
      <td>True</td>
      <td>NaN</td>
      <td>0.437013</td>
    </tr>
    <tr>
      <th>Equity(6 [1590])</th>
      <td>2.010000e+11</td>
      <td>True</td>
      <td>False</td>
      <td>0.471237</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>Equity(14 [2327])</th>
      <td>2.255366e+11</td>
      <td>True</td>
      <td>False</td>
      <td>0.528763</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>Equity(30 [2882])</th>
      <td>6.527799e+11</td>
      <td>False</td>
      <td>True</td>
      <td>NaN</td>
      <td>0.562987</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="algopositions">algo.positions</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="c1"># 計算實際股票部位的weight = 個股持股市值／所有股票部位的持股市值加總</span>
<a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a><span class="n">pos</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">positions</span>
<a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a>
<a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;mv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;last_sale_price&#39;</span><span class="p">]</span>
<a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a>
<a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a><span class="n">positive_sum</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;mv&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="s1">&#39;mv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a><span class="n">negative_sum</span> <span class="o">=</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;mv&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="s1">&#39;mv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;mv&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-70-9" name="__codelineno-70-9" href="#__codelineno-70-9"></a>                            <span class="n">pos</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">positive_sum</span><span class="p">),</span>
<a id="__codelineno-70-10" name="__codelineno-70-10" href="#__codelineno-70-10"></a>                            <span class="n">pos</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">negative_sum</span><span class="p">))</span>
<a id="__codelineno-70-11" name="__codelineno-70-11" href="#__codelineno-70-11"></a>
<a id="__codelineno-70-12" name="__codelineno-70-12" href="#__codelineno-70-12"></a><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;mv&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">]</span>
<a id="__codelineno-70-13" name="__codelineno-70-13" href="#__codelineno-70-13"></a><span class="n">pos</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sid</th>
      <th>symbol</th>
      <th>asset</th>
      <th>amount</th>
      <th>cost_basis</th>
      <th>last_sale_price</th>
      <th>mv</th>
      <th>sum</th>
      <th>weight</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-09-22 13:30:00+08:00</th>
      <td>34</td>
      <td>2886</td>
      <td>Equity(34 [2886])</td>
      <td>147424</td>
      <td>37.854390</td>
      <td>37.80</td>
      <td>5572627.20</td>
      <td>8058923.60</td>
      <td>0.691485</td>
    </tr>
    <tr>
      <th>2023-09-22 13:30:00+08:00</th>
      <td>46</td>
      <td>4904</td>
      <td>Equity(46 [4904])</td>
      <td>34484</td>
      <td>72.204762</td>
      <td>72.10</td>
      <td>2486296.40</td>
      <td>8058923.60</td>
      <td>0.308515</td>
    </tr>
    <tr>
      <th>2023-09-22 13:30:00+08:00</th>
      <td>10</td>
      <td>2301</td>
      <td>Equity(10 [2301])</td>
      <td>-33495</td>
      <td>119.468922</td>
      <td>120.00</td>
      <td>-4019400.00</td>
      <td>8113352.50</td>
      <td>-0.495406</td>
    </tr>
    <tr>
      <th>2023-09-22 13:30:00+08:00</th>
      <td>44</td>
      <td>3231</td>
      <td>Equity(44 [3231])</td>
      <td>-39941</td>
      <td>102.046428</td>
      <td>102.50</td>
      <td>-4093952.50</td>
      <td>8113352.50</td>
      <td>-0.504594</td>
    </tr>
    <tr>
      <th>2023-09-25 13:30:00+08:00</th>
      <td>10</td>
      <td>2301</td>
      <td>Equity(10 [2301])</td>
      <td>-33646</td>
      <td>119.468898</td>
      <td>120.00</td>
      <td>-4037520.00</td>
      <td>7969312.50</td>
      <td>-0.506633</td>
    </tr>
    <tr>
      <th>2023-09-25 13:30:00+08:00</th>
      <td>24</td>
      <td>2603</td>
      <td>Equity(24 [2603])</td>
      <td>38418</td>
      <td>116.165508</td>
      <td>116.00</td>
      <td>4456488.00</td>
      <td>8011632.00</td>
      <td>0.556252</td>
    </tr>
    <tr>
      <th>2023-09-25 13:30:00+08:00</th>
      <td>6</td>
      <td>1590</td>
      <td>Equity(6 [1590])</td>
      <td>3624</td>
      <td>982.405312</td>
      <td>981.00</td>
      <td>3555144.00</td>
      <td>8011632.00</td>
      <td>0.443748</td>
    </tr>
    <tr>
      <th>2023-09-25 13:30:00+08:00</th>
      <td>39</td>
      <td>2912</td>
      <td>Equity(39 [2912])</td>
      <td>-14865</td>
      <td>263.316060</td>
      <td>264.50</td>
      <td>-3931792.50</td>
      <td>7969312.50</td>
      <td>-0.493367</td>
    </tr>
    <tr>
      <th>2023-09-26 13:30:00+08:00</th>
      <td>10</td>
      <td>2301</td>
      <td>Equity(10 [2301])</td>
      <td>-39051</td>
      <td>119.468888</td>
      <td>120.00</td>
      <td>-4686120.00</td>
      <td>7921019.20</td>
      <td>-0.591606</td>
    </tr>
    <tr>
      <th>2023-09-26 13:30:00+08:00</th>
      <td>25</td>
      <td>2609</td>
      <td>Equity(25 [2609])</td>
      <td>39964</td>
      <td>46.015565</td>
      <td>45.95</td>
      <td>1836345.80</td>
      <td>7910665.20</td>
      <td>0.232135</td>
    </tr>
    <tr>
      <th>2023-09-26 13:30:00+08:00</th>
      <td>34</td>
      <td>2886</td>
      <td>Equity(34 [2886])</td>
      <td>160484</td>
      <td>37.904710</td>
      <td>37.85</td>
      <td>6074319.40</td>
      <td>7910665.20</td>
      <td>0.767865</td>
    </tr>
    <tr>
      <th>2023-09-26 13:30:00+08:00</th>
      <td>31</td>
      <td>2883</td>
      <td>Equity(31 [2883])</td>
      <td>-274144</td>
      <td>11.747586</td>
      <td>11.80</td>
      <td>-3234899.20</td>
      <td>7921019.20</td>
      <td>-0.408394</td>
    </tr>
    <tr>
      <th>2023-09-27 13:30:00+08:00</th>
      <td>10</td>
      <td>2301</td>
      <td>Equity(10 [2301])</td>
      <td>-26553</td>
      <td>119.388370</td>
      <td>120.00</td>
      <td>-3186360.00</td>
      <td>7701800.80</td>
      <td>-0.413716</td>
    </tr>
    <tr>
      <th>2023-09-27 13:30:00+08:00</th>
      <td>34</td>
      <td>2886</td>
      <td>Equity(34 [2886])</td>
      <td>129025</td>
      <td>37.945400</td>
      <td>37.70</td>
      <td>4864242.50</td>
      <td>7806390.10</td>
      <td>0.623110</td>
    </tr>
    <tr>
      <th>2023-09-27 13:30:00+08:00</th>
      <td>33</td>
      <td>2885</td>
      <td>Equity(33 [2885])</td>
      <td>116984</td>
      <td>25.185992</td>
      <td>25.15</td>
      <td>2942147.60</td>
      <td>7806390.10</td>
      <td>0.376890</td>
    </tr>
    <tr>
      <th>2023-09-27 13:30:00+08:00</th>
      <td>8</td>
      <td>2002</td>
      <td>Equity(8 [2002])</td>
      <td>-177424</td>
      <td>25.337349</td>
      <td>25.45</td>
      <td>-4515440.80</td>
      <td>7701800.80</td>
      <td>-0.586284</td>
    </tr>
    <tr>
      <th>2023-09-28 13:30:00+08:00</th>
      <td>10</td>
      <td>2301</td>
      <td>Equity(10 [2301])</td>
      <td>-33420</td>
      <td>119.711756</td>
      <td>121.50</td>
      <td>-4060530.00</td>
      <td>7843566.00</td>
      <td>-0.517689</td>
    </tr>
    <tr>
      <th>2023-09-28 13:30:00+08:00</th>
      <td>34</td>
      <td>2886</td>
      <td>Equity(34 [2886])</td>
      <td>158184</td>
      <td>37.910076</td>
      <td>37.70</td>
      <td>5963536.80</td>
      <td>7745131.35</td>
      <td>0.769972</td>
    </tr>
    <tr>
      <th>2023-09-28 13:30:00+08:00</th>
      <td>25</td>
      <td>2609</td>
      <td>Equity(25 [2609])</td>
      <td>39199</td>
      <td>45.514840</td>
      <td>45.45</td>
      <td>1781594.55</td>
      <td>7745131.35</td>
      <td>0.230028</td>
    </tr>
    <tr>
      <th>2023-09-28 13:30:00+08:00</th>
      <td>17</td>
      <td>2357</td>
      <td>Equity(17 [2357])</td>
      <td>-10308</td>
      <td>365.375480</td>
      <td>367.00</td>
      <td>-3783036.00</td>
      <td>7843566.00</td>
      <td>-0.482311</td>
    </tr>
    <tr>
      <th>2023-10-02 13:30:00+08:00</th>
      <td>10</td>
      <td>2301</td>
      <td>Equity(10 [2301])</td>
      <td>-33420</td>
      <td>119.711756</td>
      <td>125.50</td>
      <td>-4194210.00</td>
      <td>6449435.00</td>
      <td>-0.650322</td>
    </tr>
    <tr>
      <th>2023-10-02 13:30:00+08:00</th>
      <td>34</td>
      <td>2886</td>
      <td>Equity(34 [2886])</td>
      <td>148920</td>
      <td>37.920431</td>
      <td>37.60</td>
      <td>5599392.00</td>
      <td>5599392.00</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>2023-10-02 13:30:00+08:00</th>
      <td>39</td>
      <td>2912</td>
      <td>Equity(39 [2912])</td>
      <td>-8575</td>
      <td>261.819714</td>
      <td>263.00</td>
      <td>-2255225.00</td>
      <td>6449435.00</td>
      <td>-0.349678</td>
    </tr>
    <tr>
      <th>2023-10-03 13:30:00+08:00</th>
      <td>10</td>
      <td>2301</td>
      <td>Equity(10 [2301])</td>
      <td>-32363</td>
      <td>119.706008</td>
      <td>123.00</td>
      <td>-3980649.00</td>
      <td>7756069.00</td>
      <td>-0.513230</td>
    </tr>
    <tr>
      <th>2023-10-03 13:30:00+08:00</th>
      <td>34</td>
      <td>2886</td>
      <td>Equity(34 [2886])</td>
      <td>136276</td>
      <td>37.935899</td>
      <td>37.65</td>
      <td>5130791.40</td>
      <td>7442672.40</td>
      <td>0.689375</td>
    </tr>
    <tr>
      <th>2023-10-03 13:30:00+08:00</th>
      <td>39</td>
      <td>2912</td>
      <td>Equity(39 [2912])</td>
      <td>-14410</td>
      <td>261.422628</td>
      <td>262.00</td>
      <td>-3775420.00</td>
      <td>7756069.00</td>
      <td>-0.486770</td>
    </tr>
    <tr>
      <th>2023-10-03 13:30:00+08:00</th>
      <td>24</td>
      <td>2603</td>
      <td>Equity(24 [2603])</td>
      <td>20922</td>
      <td>110.657508</td>
      <td>110.50</td>
      <td>2311881.00</td>
      <td>7442672.40</td>
      <td>0.310625</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="algodict_record_vars">algo.dict_record_vars</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="n">record_vars</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">dict_record_vars</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="c1"># 實際持股市值 = 個股持股市值／所有股票部位的持股市值加總 * max_leverage</span>
<a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a><span class="n">record_vars</span><span class="p">[</span><span class="s1">&#39;daily_weights&#39;</span><span class="p">]</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>symbol</th>
      <th>daily_weights</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2023-09-22 00:00:00+08:00</td>
      <td>2886</td>
      <td>0.559924</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2023-09-22 00:00:00+08:00</td>
      <td>4904</td>
      <td>0.249817</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2023-09-22 00:00:00+08:00</td>
      <td>2301</td>
      <td>-0.403860</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2023-09-22 00:00:00+08:00</td>
      <td>3231</td>
      <td>-0.411351</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2023-09-25 00:00:00+08:00</td>
      <td>2301</td>
      <td>-0.407072</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2023-09-25 00:00:00+08:00</td>
      <td>2603</td>
      <td>0.449313</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2023-09-25 00:00:00+08:00</td>
      <td>1590</td>
      <td>0.358437</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2023-09-25 00:00:00+08:00</td>
      <td>2912</td>
      <td>-0.396412</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2023-09-26 00:00:00+08:00</td>
      <td>2886</td>
      <td>0.622353</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2023-09-26 00:00:00+08:00</td>
      <td>2301</td>
      <td>-0.480123</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2023-09-26 00:00:00+08:00</td>
      <td>2609</td>
      <td>0.188145</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2023-09-26 00:00:00+08:00</td>
      <td>2883</td>
      <td>-0.331436</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2023-09-27 00:00:00+08:00</td>
      <td>2886</td>
      <td>0.501285</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2023-09-27 00:00:00+08:00</td>
      <td>2301</td>
      <td>-0.328371</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2023-09-27 00:00:00+08:00</td>
      <td>2885</td>
      <td>0.303203</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2023-09-27 00:00:00+08:00</td>
      <td>2002</td>
      <td>-0.465339</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2023-09-28 00:00:00+08:00</td>
      <td>2886</td>
      <td>0.618396</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2023-09-28 00:00:00+08:00</td>
      <td>2301</td>
      <td>-0.421061</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2023-09-28 00:00:00+08:00</td>
      <td>2609</td>
      <td>0.184744</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2023-09-28 00:00:00+08:00</td>
      <td>2357</td>
      <td>-0.392286</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2023-10-02 00:00:00+08:00</td>
      <td>2886</td>
      <td>0.597376</td>
    </tr>
    <tr>
      <th>21</th>
      <td>2023-10-02 00:00:00+08:00</td>
      <td>2301</td>
      <td>-0.447463</td>
    </tr>
    <tr>
      <th>22</th>
      <td>2023-10-02 00:00:00+08:00</td>
      <td>2912</td>
      <td>-0.240600</td>
    </tr>
    <tr>
      <th>23</th>
      <td>2023-10-03 00:00:00+08:00</td>
      <td>2886</td>
      <td>0.542337</td>
    </tr>
    <tr>
      <th>24</th>
      <td>2023-10-03 00:00:00+08:00</td>
      <td>2301</td>
      <td>-0.420764</td>
    </tr>
    <tr>
      <th>25</th>
      <td>2023-10-03 00:00:00+08:00</td>
      <td>2603</td>
      <td>0.244371</td>
    </tr>
    <tr>
      <th>26</th>
      <td>2023-10-03 00:00:00+08:00</td>
      <td>2912</td>
      <td>-0.399071</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="c1"># 個股總市值</span>
<a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a><span class="n">record_vars</span><span class="p">[</span><span class="s1">&#39;Market_Cap_Dollars&#39;</span><span class="p">]</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>symbol</th>
      <th>Market_Cap_Dollars</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2023-09-21 00:00:00+08:00</td>
      <td>1101</td>
      <td>2.458148e+11</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2023-09-21 00:00:00+08:00</td>
      <td>1216</td>
      <td>4.028549e+11</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2023-09-21 00:00:00+08:00</td>
      <td>1301</td>
      <td>5.245370e+11</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2023-09-21 00:00:00+08:00</td>
      <td>1303</td>
      <td>5.424682e+11</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2023-09-21 00:00:00+08:00</td>
      <td>1326</td>
      <td>3.798049e+11</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>443</th>
      <td>2023-10-03 00:00:00+08:00</td>
      <td>6415</td>
      <td>1.188855e+11</td>
    </tr>
    <tr>
      <th>444</th>
      <td>2023-10-03 00:00:00+08:00</td>
      <td>6505</td>
      <td>7.649346e+11</td>
    </tr>
    <tr>
      <th>445</th>
      <td>2023-10-03 00:00:00+08:00</td>
      <td>6669</td>
      <td>2.867389e+11</td>
    </tr>
    <tr>
      <th>446</th>
      <td>2023-10-03 00:00:00+08:00</td>
      <td>9910</td>
      <td>1.920654e+11</td>
    </tr>
    <tr>
      <th>447</th>
      <td>2023-10-03 00:00:00+08:00</td>
      <td>IR0001</td>
      <td>5.189094e+13</td>
    </tr>
  </tbody>
</table>
<p>448 rows × 3 columns</p>
</div>

<p><a href="#menu">Return to Menu</a> </p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../Install%20TQuant%20Lab%20%283%29/" class="md-footer__link md-footer__link--prev" aria-label="Previous: TQuant Lab 安裝教學">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                TQuant Lab 安裝教學
              </div>
            </div>
          </a>
        
        
          
          <a href="../TSMC%20buy%20and%20hold%20strategy/" class="md-footer__link md-footer__link--next" aria-label="Next: TSMC 買進持有策略">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                TSMC 買進持有策略
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; TEJ/All Rights Reserved.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/tejtw" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/showcase/%E5%8F%B0%E7%81%A3%E7%B6%93%E6%BF%9F%E6%96%B0%E5%A0%B1-tej-?originalSubdomain=tw" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3M447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/your-twitter-handle" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            




  


<h4>Cookie consent</h4>
<p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p>
<input class="md-toggle" type="checkbox" id="__settings" >
<div class="md-consent__settings">
  <ul class="task-list">
    
      
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="analytics" >
          <span class="task-list-indicator"></span>
          Google Analytics
        </label>
      </li>
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Accept</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Manage settings</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["announce.dismiss", "navigation.instant", "navigation.instant.progress", "navigation.tracking", "navigation.tabs", "navigation.sections", "navigation.top", "navigation.footer", "search.suggest", "search.highlight", "search.share", "navigation.expand", "navigation.indexes", "content.tabs.link", "content.tooltips", "content.code.copy", "content.code.select", "content.action.edit", "content.action.view", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
    
  </body>
</html>